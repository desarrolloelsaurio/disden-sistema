PROCEDURE IMER_DO
* EL PROGRAMA DERIVA OPERACIONES SOBRE LA BASE DE MERCADERIAS
* TRABAJA A PARTIR DE MERRED Y IMER_DO.SPR
#DEFINE CRLF CHR(13)+CHR(10)                     && CRLF
#DEFINE BOTOM  "  "+repl("°",78)                 && BOTOM
#DEFINE NUL    0                                 && NUL
#DEFINE PAIP   "|"                               && PAIP
FUNCTION IMER_DO
DO CASE
CASE COD_HACER=1 && INGRESA DESPIECE DE AVIOS
	STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICULO
	DO IIDES WITH "A"
	=RELEWIN("IIDES")
CASE COD_HACER=2 && INGRESA DESPIECE DE TELAS
	STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICULO
	DO IIDES WITH "T"
	=RELEWIN("IIDES")
CASE COD_HACER=3 && COPIA DESPIECE COMPLETO A NUEVO COLOR
   IF VALCOLOR()
      IF ELISUE(' Color a Crear Despiece',1,-1)
		 =WORKING()
         TMP=GENTMP()
         =DOTALK()
         M.ARTICULO=left(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2)
         SELE DES
         COPY TO (TMP) FOR DES.ARTICULO = M.ARTICOLOR
         =PRXAREA(.T.)
         USE (TMP) ALIAS TMP
         SELE TMP
         REPL ARTICULO WITH M.ARTICULO ALL
         SELE DES
         APPEND FROM (TMP)
         =OFF_TMP()
         =UNTALK()
         =UNWORK()
      ELSE
         =WNCL("NO SE ELIGIO COLOR")
      ENDIF
   ELSE
      =WNCL("NO EXISTE EL DESPIECE")
   ENDIF
   STORE NUL TO M.RESPUESTA
CASE COD_HACER=4 && REPITE ARTICULO
   TXT=ALLTRIM(MER.MERCA1)
   STORE NUL TO M.RESPUESTA
   DO WHILE !EMPTY(elisue("del Producto",-1,1))
      clr=LEFT(MIX.TEXTO2,2)
      sele mer
      m.articulo=left(articulo,11)+clr
      set order to TAG ARTICULO
      if !seek(left(m.articulo,13))
         =men_lin(grabando)
         =AGRABAR("MER")
         SELE MER
         =LOCK() .OR. LOK()
         repl MER.merca1 with ""
         REPL MER.MERCA1 WITH TXT
         REPL MER.SUELA WITH LEFT(MIX.TEXTO2,2)
         =REPUSE()
         unlo in mer
         =iaud(mer.merca)
      else
         do MENSAJ1 with "EL ARTICULO EXISTE - No lo Puedo Repetir"
      endif
      STORE NUL TO M.RESPUESTA
   enddo
CASE COD_HACER=5 && REPITE DESCRIPCION DE ARTICULO
   txt=mer.merca1
   STOR NUL TO respuesta
   do while !EMPTY(eliMER("de Destino",-1,1))
      =MEN_LIN(GRABANDO)
      =LOCK() .OR. lok("mer")
      repl MER.merca1 with txt addi
      =REPUSE()
      unlo in mer
      =iaud(mer.merca)
      STOR NUL TO respuesta
   enddo
CASE COD_HACER=6 && PIDE DATO DE ARTICULO CON COLOR - ACTUALIZA AVIOS
   =IIF(VALCOLOR(),ACDESAVI(M.ARTICOLOR),WNCL("NO EXISTE EL DESPIECE"))
CASE COD_HACER=7 && PIDE DATO DE ARTICULO CON COLOR - ACTUALIZA TELAS
   =IIF(VALCOLOR(),ACDESTEL(M.ARTICOLOR),WNCL("NO EXISTE EL DESPIECE"))
CASE COD_HACER=8 && PIDE DATO DE ARTICULO CON COLOR - LISTA DESPIECE completo
   =IIF(VALCOLOR(),LDESNT(PORPAN,"C",M.ARTICOLOR),WNCL("NO EXISTE EL DESPIECE"))
CASE COD_HACER=9 && PIDE DATO DE ARTICULO CON COLOR - LISTA DESPIECE enumerado
   =IIF(VALCOLOR(),LDESNT(PORPAN,"E",M.ARTICOLOR),WNCL("NO EXISTE EL DESPIECE"))
CASE COD_HACER=10 && PIDE DATO DE ARTICULO CON COLOR - COPIA DESPIECE A TALLE
   IF VALCOLOR()
      DO REDSTAL.SPR WITH M.ARTICOLOR
   ELSE
      =WNCL("NO EXISTE EL DESPIECE")
   ENDIF
CASE COD_HACER=11 && PIDE DATO DE ARTICULO CON COLOR - INGRESA ESTRUCTURA
   STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
   DO IEST WITH M.ARTICOLOR
CASE COD_HACER=12 && PIDE DATO DE ARTICULO CON COLOR - MODIFICA ESTRUCTURA
   STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
   DO CEST WITH M.ARTICOLOR
CASE COD_HACER=13 && PIDE DATO DE ARTICULO CON COLOR - BORRA ESTRUCTURA
   STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
   =BESTT(M.ARTICOLOR)
CASE COD_HACER=14 .OR. COD_HACER=15 .OR. COD_HACER=16
   * PIDE DATO DE ARTICULO CON COLOR - BORRA DESPIECE TOTAL, TELAS, AVIOS
   IF VALCOLOR()
      =FLOCK("DES") .OR. FLOK("DES")
  	  =WORKING()
      =DOTALK()
      SELE DES
      DO CASE
      CASE COD_HACER=14
         DELE FOR ARTICULO=M.ARTICOLOR
      CASE COD_HACER=15
         DELE FOR !EMPTY(TELCODPRO) .AND. ARTICULO=M.ARTICOLOR
      CASE COD_HACER=16
         DELE FOR !EMPTY(AVICODPRO) .AND. ARTICULO=M.ARTICOLOR
      ENDCASE
      =UNTALK()
      =UNWORK()
      UNLO IN DES
      =IAUD(M.ARTICOLOR)
   ELSE
      =WNCL("NO EXISTE EL DESPIECE")
   ENDIF
CASE COD_HACER=17 .OR. COD_HACER=18
   * PIDE DATO DE ARTICULO CON COLOR - BORRA DESPIECE TOTAL EN 1 ART. AVIOS
   IF VALCOLOR()
      DO BDESMAT.SPR WITH "U", IIF(COD_HACER=18, "T", "A"),  ARTICOLOR
   ELSE
      =WNCL("NO EXISTE EL DESPIECE")
   ENDIF
CASE COD_HACER=19 .OR. COD_HACER=20
   * PIDE DATO DE ARTICULO CON COLOR - REEMP. DESPIECE TOTAL EN 1 ART. AVIOS
   IF VALCOLOR()
      DO RDESMAT.SPR WITH "U", IIF(COD_HACER=20, "T", "A"),  ARTICOLOR
   ELSE
      =WNCL("NO EXISTE EL DESPIECE")
   ENDIF
CASE COD_HACER=21 && PIDE DATO DE ARTICULO CON COLOR - BORRA despiece
   STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
   =BESTP(M.ARTICOLOR)
CASE COD_HACER=22
   * PIDE DATO DE ARTICULO CON COLOR - LISTA ESTRUC.
   STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
   TMP=GENTMP()
	=WORKING()
   =DOTALK()
   SELE EST
   SORT ON POSICION TO (TMP) FOR est.articulo=articolor
   =PRXAREA(.T.)
   USE (TMP) ALIAS TMP
   TT='Listado de Estructura de Producto '+CRLF+;
        mer.articulo+' - '+alltrim(mer.merca)+CRLF+;
        'Estructura :'+LEFT(MIX.TEXTO2,2)+' - '+ALLT(MIX.TEXTO1)
   aclaPRN =PAIP+'POSIC'+PAIP+;
     PADC('PROCESO DE FABRICACION',30)+PAIP+;
     PADC('CONDICION',40)+PAIP+;
     PADC('COSTO',XACDIGI)+PAIP+;
     PADC('T.ESTIM.',11)+PAIP+;
     PADC('T.REAL',11)+PAIP+;
     PADC('FECHA',8)+PAIP+;
     PADC('USUARIO',10)+PAIP
  aclaPAN =PAIP+'POSIC'+PAIP+;
     PADC('PROCESO DE FABRICACION',23)+PAIP+;
     PADC('T.ESTIM.',8)+PAIP+;
     PADC('T.REAL',8)+PAIP+;
     PADC('FECHA',8)+PAIP+;
     PADC('USUARIO',10)+PAIP
  =UNTALK()
  =UNWORK()
  =XPRN1(4,"TMP","LEST1()",TT,"LEST1")
  =OFF_TMP()
CASE COD_HACER=23
   * PIDE DATO DE ARTICULO CON ESTRUCTURA - LISTA ESTRUC. CON DETALLE
   STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
   TMP=GENTMP()
   =WORKING()
   =DOTALK()
   SELE EST
   SORT ON POSICION TO (TMP) FOR est.articulo=articolor
   =PRXAREA(.T.)
   USE (TMP) ALIAS TMP
   acla =paip+'PROC.'+paip+;
        PADC('PROCESO DE FABRICACION',30)+PAIP+;
        padc("CONDICION",40)+PAIP
   TT='Listado de Despiece - Condiciones de Llegada del Producto'+CRLF+;
        ' - '+alltrim(mer.merca)+CRLF+;
        'Estructura :'+LEFT(MIX.TEXTO2,2)+' - '+ALLT(MIX.TEXTO1)
   =UNTALK()
   =UNWORK()
   =XPRN1(4,"TMP","LEST3()",TT,"LEST3")
   =OFF_TMP()
CASE COD_HACER=25 .OR. COD_HACER=26
   STORE .T. TO M.ESOK
   IF COD_HACER=26
      IF EMPTY(ELIPRC("a Listar",-1,1))
         STORE .F. TO M.ESOK
         =NOSELEC("PROCESO")
      ENDIF
   ENDIF
   IF M.ESOK
      TMP=GENTMP()
      =DOTALK()
	 =WORKING()
      SELE PRS
      SET ORDER TO
      TT="Listado de Presupuesto de Servicios"+;
        crlf+;
        "Art¡culo:"+alltrim(mer.articulo)+;
        crlf+;
        alltrim(mer.merca)
      =FLOCK() .OR. FLOK()
      IF COD_HACER=25
         EL_PROGRAMA="LPRS12(1)"
         EL_AUDITOR=MER.ARTICULO
         EL_NOMPROG="LPRSA"
         ACLA=PAIP+PADC("PROCESO",30)+PAIP+;
           PADC("TALLER",30)+PAIP+;
           PADC("P. UNIT.",XACDIGI)+PAIP
         SORT ON PRCCOD,CODCLI TO (TMP) FOR ARTICULO=ALLTRIM(MER.ARTICULO)
      ELSE
         EL_PROGRAMA="LPRS12(2)"
         EL_AUDITOR=MER.ARTICULO+"/"+PRC.PROCFAB
         EL_NOMPROG="LPRSAP"
         TT=TT+;
         CRLF+;
         "Proceso:"+alltrim(prc.procfab)
         SORT ON PRCCOD,CODCLI TO (TMP) FOR ARTICULO=ALLTRIM(MER.ARTICULO) .AND. ;
           PRCCOD=PRC.PRCCOD
         ACLA=PAIP+PADC("TALLER",30)+PAIP+;
           PADC("P. UNIT.",XACDIGI)+PAIP
         PRCCOD=PRC.PRCCOD
      ENDIF
      =UNLO_PRX("PRS",TMP)
      =UNTALK()
      =UNWORK()
      =xprn1(4,"TMP",EL_PROGRAMA,EL_AUDITOR,EL_NOMPROG)
      =OFF_TMP()
   ENDIF
CASE COD_HACER=27
   IF VALCOLOR()
		mrcd=ALLTRIM(mer.merca)
		STORE NUL TO camut,eltalle
		if tallecan()
			aclaPAN=PAIP+;
				+PADC("MATERIAL",20)+PAIP;
				+PADC("CANTIDAD",10)+PAIP;
				+PADC("U. COMPRA",10)+PAIP;
				+PADC("EXISTENCIA",10)+PAIP;
				+PADC("COSTO",XACDIGI)+PAIP
			aclaPRN=PAIP+;
				+PADC("MATERIAL",30)+PAIP;
				+PADC("CANTIDAD",10)+PAIP;
				+PADC("U. COMPRA",10)+PAIP;
				+PADC("EXISTENCIA",10)+PAIP;
				+PADC("NECESIDAD",10)+PAIP;
				+PADC("INVERSION",XACDIGI)+PAIP;
				+PADC("COSTO",XACDIGI)+PAIP
			tt='Proyecci¢n de Costo de Materia Prima'+CRLF+;
				'Producto:'+mrcd+' Color:'+ALLTR(MIX.TEXTO1)+CRLF+;
				'Cantidad:'+alltrim(STR(camut))+' - Talle:'+alltrim(str(eltalle))
			SELE DES
			=FLOCK() .OR. FLOK()
			TMP=GENTMP()
			=WORKING()
			=DOTALK()
			SORT ON AVICODPRO, TELCODPRO TO (TMP) FOR articulo=ARTICOLOR .AND. (tipo=LEFT(abio,1) .OR. tipo=LEFT(tella,1)) .AND. TALLE=ELTALLE
		    UNLO IN DES
			=PRXAREA(.T.)
			USE (TMP) ALIAS TMP EXCL
			=UNTALK()
			=UNWORK()
			=XPRN1(4,"TMP","CCOS0()","","CCOS",2,REPL("9",XACDIGI-3)+".99")
			=OFF_TMP()
		ENDIF
   ELSE
      =WNCL("NO EXISTE EL DESPIECE")
   ENDIF
CASE COD_HACER=28
	=OPEST()
	=OPPRC()
	MRCD=ALLTRIM(MER.MERCA)
	STORE NUL TO CAMUT,ELTALLE
	=MEN_LIN(MRCD)
	CAMUT=INFIC("Unidades a Fabricar",9999999)
	IF !EMPTY(CAMUT)
		acla=PAIP+"POSI"+PAIP+PADC("PROCESO",30)+PAIP+PADC("COSTO UNIT.",XACDIGI)+PAIP+PADC("COSTO TOTAL",XACDIGI)+PAIP
		tt='Proyecci¢n de Costo de Mano de Obra'+CRLF+;
			'Producto:'+mrcd+' Est.:'+ALLTR(MIX.TEXTO1)+CRLF+;
			'Cantidad:'+alltrim(STR(camut))
		SELE EST
		=FLOCK() .OR. FLOK()
		TMP=GENTMP()
		=WORKING()
		=DOTALK()
		STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTIESTRU
		SORT ON POSICION TO (TMP) FOR ARTICULO=ARTIESTRU
    	UNLO IN EST
		=PRXAREA(.T.)
		USE (TMP) ALIAS TMP EXCL
		=UNTALK()
		=UNWORK()
		=XPRN1(4,"TMP","CMOB0()","","CMOB",2,REPL("9",XACDIGI-3)+".99")
		=OFF_TMP()
	ENDIF
CASE COD_HACER=29
	MRCD=ALLTRIM(MER.MERCA)
	STORE NUL TO CAMUT,ELTALLE
	=MEN_LIN(MRCD)
	IF TALLECAN()
        aclapan=PAIP+PADC("MATERIAL",20)+PAIP+;
        	PADC("CANTIDAD",11) +PAIP+;
        	PADC("U. COMPRA",10)+PAIP+;
        	PADC("EXISTENCIA",11)+PAIP+;
        	PADC("NECES.",11)+PAIP
        aclaprn=PAIP+PADC("MATERIAL",30)+PAIP+;
        	PADC("CANTIDAD",11) +PAIP+;
        	PADC("U. COMPRA",10)+PAIP+;
        	PADC("EXISTENCIA",11)+PAIP+;
        	PADC("NECES.",11)+PAIP
		tt='Proyecci¢n de Stock P/Fabricaci¢n'+CRLF+;
			'Producto:'+mrcd+' Talle:'+alltrim(str(eltalle))+CRLF+;
			'Cantidad:'+alltrim(STR(camut))
		SELE DES
		=FLOCK() .OR. FLOK()
		TMP=GENTMP()
		=WORKING()
		=DOTALK()
		STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
		SORT ON TELCODPRO, AVICODPRO TO (TMP) ;
				FOR ARTICULO=ARTICOLOR .and. talle=eltalle
    	UNLO IN DES
		=PRXAREA(.T.)
		USE (TMP) ALIAS TMP EXCL
		=UNTALK()
		=UNWORK()
		=XPRN1(4,"TMP","CEXI0()","","CEXI",1,REPL("9",XACDIGI-3)+".99")
		=OFF_TMP()
	ENDIF
CASE COD_HACER=30
=DOTALK()
=WORKING()
TMP=GENTMP()	
=OPDES()
SELE DES 
SET ORDER TO
=FLOCK() .OR. FLOK()
SORT ON ARTICULO TO (TMP) FOR LEFT(ARTICULO,10)=LEFT(M.ARTICULO,10)
=UNLO_PRX("DES",TMP)
INDEX ON LEFT(ARTICULO,13) TAG ARTICULO UNIQ
SET ORDER TO TAG ARTICULO
EXTERNAL PROCEDURE LDESUA
TT="Despieces del Art¡culo"+;
CRLF+;
alltrim(mer.articulo)+' / '+alltrim(mer.merca)
ACLA=paip+"CO"+PAIP+PADC("COLOR",20)+PAIP
=XPRN1(4,"TMP","LDESUA()",MER.ARTICULO,"LDESUA")
=UNTALK()
=UNWORK()
=OFF_TMP()
CASE COD_HACER=98
	IF CONCOLORES
	   IF !VALCOLOR()
    	  M.ARTIC_CLR= ARTICOLOR
	      CLEA READ
	   ELSE
    	  =WNCL("EL DESPIECE YA EXISTE")
	   ENDIF
	ELSE
	   IF !VALESTRU()
    	  M.ARTIC_CLR= ARTIESTRU
	      CLEA READ
	   ELSE
    	  =WNCL("LA ESTRUCTURA YA EXISTE")
	   ENDIF
   ENDIF
CASE COD_HACER=99
	IF CONCOLORES
	   IF VALCOLOR()
    	  M.ARTIC_CLR= ARTICOLOR
	      CLEA READ
	   ELSE
	      =WNCL("NO EXISTE EL DESPIECE")
	   ENDIF
	ELSE
	   IF VALESTRU()
    	  M.ARTIC_CLR= ARTIESTRU
	      CLEA READ
	   ELSE
		  =WNCL("NO EXISTE LA ESTRUCTURA")
	   ENDIF
   ENDIF
ENDCASE
RETURN .T.
 
FUNCTION VALCOLOR
STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTICOLOR
RETURN XSEEK(M.ARTICOLOR,"DES","ARTICULO")

FUNCTION VALESTRU
STORE LEFT(MER.ARTICULO,11)+LEFT(MIX.TEXTO2,2) TO M.ARTIESTRU
RETURN XSEEK(M.ARTIESTRU,"EST","ARTICULO")
