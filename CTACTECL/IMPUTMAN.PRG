* ษออออออออออออออออออออออออออออออออออออออป
* บ PROCEDIMIENTO : IMPUTMAN.PRG         บ
* บ COMENTARIO    : IMPUTACION MANUAL    บ
* ฬออออออออออออออออออออออออออออออออออออออน
* บ AUTOR      : GOYO REINER             บ
* บ FECHA      : 08-24-93                บ
* บ HORA       : 09:09:09pm              บ
* บ COPYRIGHT  : 1993 by GREGORIO REINER บ
* ศออออออออออออออออออออออออออออออออออออออผ
ELCLIENTE=PER.CLIENTE
RE_CLIENTE=PER.CODCLI
ULPR=HORA_ULP(PROGRAM())
IF CHEQSEG()
	SELE CCL
	=MEN_LIN("CALCULANDO MONTOS ABONADOS")
	SET ORDER TO TAG CODCLI
	IF SEEK(RE_CLIENTE)
		COMPRASTMP=GENTMP()
		PAGOSTMP=GENTMP()
		STORE NUL TO RE_SUMA,RE_RECIS,RE_CREDS,RE_ARRAY,RE_PUNTERO
		SET ORDER TO
		=FLOCK("CCL") .OR. FLOK("CCL")
		STORE RECC("CCL") TO CANTREC
		#IF "ALQ" $ CURD()
		SORT ON NUMERO,FECHAOP,COMPRRE,NUMERORE TO (PAGOSTMP) FOR CODCLI=RE_CLIENTE
		#ELSE
		SORT ON COMPR,COMPRRE,NUMERORE TO (PAGOSTMP) FOR CODCLI=RE_CLIENTE
		#ENDIF
		SELE CCL
		USE
		USE (PAGOSTMP) ALIAS CCL IN 5 EXCL
		COPY TO (COMPRASTMP) FOR ESDEBE(CCL.COMPRRE)
		DELE FOR ESDEBE(CCL.COMPRRE)
		PACK
		CALC SUM(ABS(CCL.MONTO)) TO RE_SUMA
		IF !EMPTY(RE_SUMA)
			=MEN_LIN("BORRANDO IMPUTACION ANTERIOR")
			REPL ALL PAGADA WITH .T.
			REPL ALL CUOTA WITH NUL
			SELE 25
			USE (COMPRASTMP) ALIAS CPR EXCL
			REPL ALL CPR.CUOTA WITH NUL,;
			CPR.PAGADA WITH .F.
			INDEX ON NUMERORE TAG SHIT
			GO TOP
			=MOVEWIN(0,0,24,79,"WIN"," CLIENTE:"+ALLTRIM(PER.CLIENTE)+" "," [ESC] SALE - [CTRL H] AYUDA ")
			defi wind win1 from 0,0 to 12,77 in win TITL "DEUDAS"
			acti wind win1
			defi wind win2 from 12,0 to 22,77 in win TITL "PAGOS"
			acti wind win2
			acti wind win
			sele CCL
			GO TOP
			=IMPUTMA2("WIN1"," PAGOS ",.F.,"EMPTY(CUOTA)")
			ON KEY LABEL CTRL+H DO IMPUHELP
			ON KEY LABEL F2 KEYB CHR(23)
			ON KEY LABEL F3 DO IMPUOK
			ON KEY LABEL PGDN GO BOTT
			ON KEY LABEL PGUP GO TOP
			DO WHILE .T.
				SELE CPR
				IF IMPUTMA1("WIN2"," COMPRAS ",.T.,"!PAGADA")
					EXIT
				ENDIF
				sele CCL
				IF IMPUTMA1("WIN1"," PAGOS ",.F.,"EMPTY(CUOTA)")
					exit
				ENDIF
			ENDDO
			ON KEY LABEL F2
			ON KEY LABEL CTRL+H
			ESOK=CONFIRMA("IMPUTACIONES REALIZADAS",.T.,10,0)
			RELE WIND WIN2
			RELE WIND WIN1
			RELE WIND WIN
			IF ESOK
				SELE CCL
				REPL ALL CUOTA WITH 0
				APPE FROM (COMPRASTMP)
				USE IN 25
				SELE CCL
				SET ORDER TO
				TMP=GENTMP()
				#IF "ALQ" $ CURD()
				DELE FOR EMPTY(MONTO) .AND. ;
				LEFT(DETALLE,3)#"INM" .AND. ;
				LEFT(DETALLE,3)#"MUN" .AND. ;
				LEFT(DETALLE,3)#"DIP"
				#ELSE
				DELE FOR EMPTY(MONTO)
				#ENDIF
				PACK
				SORT ON FECHAOP,FECHAVE,NUMERORE TO (TMP)
				USE IN CCL
				=OPCCL()
				=FLOCK() .OR. FLOK()
				SET ORDER TO
				DELE FOR CCL.CODCLI=RE_CLIENTE .AND. RECNO()<=CANTREC
				APPE FROM (TMP)
				UNLO IN CCL
				=IAUD(PER.CODCLI)
			ELSE
				=REOPCCL()
				=IAUD("NO "+PER.CODCLI)
			ENDIF
		ELSE
			=CARTEL("NO SE PUEDE REALIZAR LA REIMPUTACION",;
			"DADO QUE EL CLIENTE",;
			ALLTRIM(PER.CLIENTE)+"("+ALLTRIM(PER.CODCLI)+")",;
			"NO TIENE NI RECIBOS NI NOTAS DE CREDITO")
			=IAUD("NO "+PER.CODCLI)
		ENDIF
	ENDIF
ELSE
	=IAUDI()
ENDIF
USE IN 25
ON KEY LABEL CTRL+H
ON KEY LABEL F2
ON KEY LABEL F3
ON KEY LABEL PGDN
ON KEY LABEL PGUP
=OFF_TMP()
RETURN REOPCCL()

FUNCTION IMPUHELP
	=MOVECENT(0,0,9,30,"IMPUHELP",' COMANDOS ')
	@ 1,1 SAY "[F2]    CAMBIA DE VENTANA"
	@ 2,1 SAY "[F3]    IMPUTA"
	@ 3,1 SAY "[ESC]   SALE DEL PROGRAMA"
	@ 4,1 SAY "[PgDn]  FIN DEL ARCHIVO"
	@ 5,1 SAY "[PgUp]  INICIO DEL ARCHIVO"
	@ 6,1 SAY "[ENTER] SALE DE AYUDA"
	=INKEY(0,'HM')
	RELE WIND IMPUHELP
RETURN .T.

FUNCTION IMPUTMA1
	PARAMETER IM_WIN,IM_TIT,IM_COMPRAS,IM_FISC
#IF "ALQ" $ CURD()
	brow FIELD ;
	FECHAOP:R:H="FECHA" ,;
	COMPRRE:R:H="CO" ,;
	NUMERO:R:H=PADC("RECIBO Nง",14):P=REPL("!",14) ,;
	MONTO:R:H=PADC("MONTO",12):P="9,999,999.99" ,;
	UNOMAS=IIF(IM_COMPRAS,TRANSF(MONTO-CUOTA,"9,999,999.99"),COMPR):R:H=IIF(IM_COMPRAS,PADC("PENDIENTE",12),PADC("ORIGEN",20)) ,;
	DETALLE:R:H=PADC("DETALLE",30) ;
	wind (IM_WIN) in wind win ;
	noclear FOR &IM_FISC ;
	TITL IM_TIT
#ELSE
	brow FIELD ;
	FECHAOP:R:H="FECHA" ,;
	COMPRRE:R:H="CO" ,;
	NUMERORE:R:H=PADC("COMPROBANTE",14):P=REPL("!",14) ,;
	MONTO:R:H=PADC("MONTO",12):P="9,999,999.99" ,;
	UNOMAS=IIF(IM_COMPRAS,TRANSF(MONTO-CUOTA,"9,999,999.99"),COMPR):R:H=IIF(IM_COMPRAS,PADC("PENDIENTE",12),PADC("ORIGEN",20)) ,;
	DETALLE:R:H=PADC("DETALLE",30) ;
	wind (IM_WIN) in wind win ;
	noclear FOR &IM_FISC ;
	TITL IM_TIT
#ENDIF
RETURN (readkey()=12 .or. readkey()=286)

FUNCTION IMPUTMA2
	PARAMETER IM_WIN,IM_TIT,IM_COMPRAS,IM_FISC
	#IF "ALQ" $ CURD()
	brow FIELD ;
	FECHAOP:R:H="FECHA" ,;
	COMPRRE:R:H="CO" ,;
	NUMERO:R:H=PADC("RECIBO Nง",14):P=REPL("!",14) ,;
	MONTO:R:H=PADC("MONTO",12):P="9,999,999.99" ,;
	UNOMAS=IIF(IM_COMPRAS,TRANSF(MONTO-CUOTA,"9,999,999.99"),COMPR):R:H=IIF(IM_COMPRAS,PADC("PENDIENTE",12),PADC("ORIGEN",20)) ,;
	DETALLE:R:H=PADC("DETALLE",30) ;
	wind (IM_WIN) in wind win ;
	noclear NOWAIT FOR &IM_FISC ;
	TITL IM_TIT
#ELSE
	brow FIELD ;
	FECHAOP:R:H="FECHA" ,;
	COMPRRE:R:H="CO" ,;
	NUMERORE:R:H=PADC("COMPROBANTE",14):P=REPL("!",14) ,;
	MONTO:R:H=PADC("MONTO",12):P="9,999,999.99" ,;
	UNOMAS=IIF(IM_COMPRAS,TRANSF(MONTO-CUOTA,"9,999,999.99"),COMPR):R:H=IIF(IM_COMPRAS,PADC("PENDIENTE",12),PADC("ORIGEN",20)) ,;
	DETALLE:R:H=PADC("DETALLE",30) ;
	wind (IM_WIN) in wind win ;
	noclear NOWAIT FOR &IM_FISC ;
	TITL IM_TIT
#ENDIF
RETURN .T.

FUNCTION IMPUOK
	=MOVECENT(0,0,14,50,"IMPUOK"," IMPUTA ")
	@ 1,1 SAY "FACTURA  : "+CPR.NUMERORE
	@ $+1,1 SAY "DETALLE  : "+CPR.DETALLE
	@ $+1,1 SAY "MONTO    : "+TRANS(CPR.MONTO-CPR.CUOTA,"99,999,999.99")
	@ $+2,1 SAY "PAGA CON :"
	@ $+2,1 SAY "COMPROB. : "+CCL.COMPRRE+" Nง "+CCL.NUMERORE
	@ $+1,1 SAY "MONTO    : "+TRANS(CCL.MONTO,"99,999,999.99")
	@ $+1,1 SAY "ANTERIOR : "+CCL.COMPR
	IF CONFIRMA("IMPUTAR EL COMPROBANTE",.F.,11,1)
		=WORKING()
		IF !CPR.PAGADA
			DIFERENCIA=CPR.MONTO-CPR.CUOTA
			IF DIFERENCIA>CCL.MONTO
				REPL CPR.CUOTA WITH CPR.CUOTA+CCL.MONTO
				#IF "ALQ" $ CURD()
				REPL CPR.NUMERO WITH CCL.NUMERO
				#ENDIF
				REPL CCL.COMPR WITH CPR.COMPRRE+' Nง '+CPR.NUMERORE
				REPL CCL.CUOTA WITH CCL.MONTO
				REPL CCL.DETALLE WITH IIF("CHEQUE" $ CCL.DETALLE,ALLTRIM(CCL.DETALLE),"Parc.")+" "+alltrim(cpr.detalle)
				REPL CCL.GY_DEBE WITH CCL.MONTO
			ELSE
				REPL CPR.CUOTA WITH CPR.MONTO
				REPL CPR.PAGADA WITH .T.
				#IF "ALQ" $ CURD()
				REPL CPR.NUMERO WITH CCL.NUMERO
				#ENDIF
				STORE CCL.MONTO-DIFERENCIA TO QUEDA
				SELE CCL
				IM_RECNO=RECNO()
				SCAT MEMV
				REPL CCL.COMPR WITH CPR.COMPRRE+' Nง '+CPR.NUMERORE
				REPL CCL.MONTO WITH DIFERENCIA
				REPL CCL.CUOTA WITH CCL.MONTO
				REPL CCL.GY_DEBE WITH CCL.MONTO
				#IF "ALQ" $ CURD()
				EL_DET=CCL.DETALLE
				LA_POS=AT("๐",EL_DET)
				IF EMPTY(LA_POS)
				   EL_DET1=ALLTRIM(EL_DET)
				   EL_DET2=""
				ELSE
				   EL_DET1=LEFT(EL_DET,LA_POS-1)
				   EL_DET2=SUBSTR(EL_DET,LA_POS+1)
				ENDIF
				REPL CCL.DETALLE WITH ;
				EL_DET1+;
				"๐Salda "+;
				EL_DET2+;
				IIF("CHEQUE" $ CCL.DETALLE,ALLTRIM(CCL.DETALLE),"")
				#ELSE
				REPL CCL.DETALLE WITH IIF("CHEQUE" $ CCL.DETALLE,ALLTRIM(CCL.DETALLE),"Salda")+" "+alltrim(cpr.detalle)
				#ENDIF
				IF !EMPTY(QUEDA)
					M.MONTO=QUEDA
					M.GY_DEBE=QUEDA
					=AGRABAR("CCL")
					GO IM_RECNO
				ENDIF
			ENDIF
		ENDIF
		SELE CPR
		=IMPUTMA2("WIN2"," COMPRAS ",.T.,"!PAGADA")
		SELE CCL
		=IMPUTMA2("WIN1"," PAGOS ",.F.,"EMPTY(CUOTA)")
		=UNWORK()
	ENDIF
	RELE WIND IMPUOK
RETURN MEN_LIN(BOTOM)
