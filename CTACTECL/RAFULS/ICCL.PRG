* ษอออออออออออออออออออออออออออออออออออออออออออออออออออออออป
* บ PROCEDIMIENTO : ICCL.PRG                              บ
* บ COMENTARIO    : GENERA DEUDA DE ALQUILERES EN CTA CTE บ
* ฬอออออออออออออออออออออออออออออออออออออออออออออออออออออออน
* บ AUTOR      : GOYO REINER                              บ
* บ FECHA      : 11-24-93                                 บ
* บ HORA       : 12:04:47pm                               บ
* บ COPYRIGHT  : 1993 by GREGORIO REINER                  บ
* ศอออออออออออออออออออออออออออออออออออออออออออออออออออออออผ
#DEFINE NUL    0                                 && NUL
#DEFINE BOTOM  "  "+repl("ฐ",78)                 && BOTOM

STOR HORA_ULP(PROGRAM()) TO ULPR
IF CHEQSEG()
	M.MESANIO=MESANIO("Mes y Aคo de la Liquidaciขn",.T.,.T.)
	IF !EMPTY(M.MESANIO) .AND. CONFIRMA('Liquidaciขn',.T.,15,15)
		STOR VAL(LEFT(M.MESANIO,2)) TO M.XMES
		STOR VAL(RIGHT(M.MESANIO,2)) TO M.XANIO
		STOR 'ALQ'+STR(M.XMES,2)+STR(M.XANIO,2) TO M.DETALLE,M.DETALLEOK
		STORE SPACE(8) TO M.RECIBO
        STORE 1 TO M.C_PERIODO
        STORE NUL TO M.C_CUOTA,M.REGNO
        STORE .F. TO M.MARCA
        STORE .T. TO M.MARKA
		SET ORDE TO TAG CLQCOD IN MIX
		SET ORDE TO TAG CODINM IN INM
		SELE ALQ
		=FLOCK("ALQ") .OR. FLOK("ALQ")
		SET ORDE TO TAG CODINM
		SET RELA TO CODINM INTO INM
		=WORKING()
		=DOTALK()
		M.NUMDOC=GETDOC(5)
		SCAN FOR ISALQOK()
			STOR .F. TO HAYCAMBIO
			SCAT MEMV BLAN
			STOR ALQ.CODCLI TO M.CODCLI
			STOR INM.PROCOD TO M.PROCOD
			STOR DATE() TO M.FECHAOP
			STOR ARMA_FEC(ALQ.DIAVENC,M.XMES,M.XANIO) TO M.FECHAVE
			IF DOW(M.FECHAVE)=6
				M.FECHAVE=M.FECHAVE+2
			ELSE
				IF DOW(M.FECHAVE)=1
					M.FECHAVE=M.FECHAVE+1
				ENDIF
			ENDIF
			STOR ALQ.MONEDA TO M.MONEDA
			INDICE=GEN_IND(ALQ.FECHAALQ,M.FECHAVE,ALQ.CODACT)
			IF ALQ.MONEDA=LEFT(XADOLS,1)
				STOR ALQ.MONTOBASE*INDICE TO M.EQUIVALE
				STOR M.EQUIVALE*XACOTIZ TO M.MONTO
			ELSE
				STOR ALQ.MONTOBASE*INDICE TO M.MONTO
				STOR M.MONTO/XACOTIZ TO M.EQUIVALE
			ENDIF
			IF !EMPTY(M.MONTO)
				STOR .F. TO M.PAGADA
				STOR NUL TO M.CUOTA
				STOR ALQ.CODINM TO M.CODINM
				STOR "FA" TO M.COMPRRE
				STOR M.XMES TO M.C_MES
				STOR YEAR(ARMA_FEC(1,1,M.XANIO)) TO M.C_ANIO
				STOR ALQ.COMISION TO M.C_COMIS
				IF XSEEK(LEFT(M.DETALLEOK,7)+M.CODINM,"CCL","ALQUILER")
                   IF !EMPTY(CCL.NUMERO)				
                      SELE ALQ
                      LOOP
                   ENDIF
					   IF !PAGADA
						   STOR (CCL.MONTO#M.MONTO) TO HAYCAMBIO
    					   REPL CCL.MONTO WITH M.MONTO
	 					   REPL CCL.EQUIVALE WITH M.EQUIVALE
						   REPL CCL.C_COMIS WITH M.C_COMIS
						   =REPUSE()
					   ENDIF
				    ELSE
					   M.NUMERORE=ZERO(M.NUMDOC,8)
					M.COMPR="FAI Nง "+ZERO(M.NUMDOC,8)
					M.NUMDOC=M.NUMDOC+1
					M.DETALLE=M.DETALLEOK
					M.RECIBO=SPACE(8)
					=AGRABAR("CCL")
					STOR .T. TO HAYCAMBIO
				ENDIF
				M.MONTOOK=CCL.MONTO
				IF !EMPTY(ALQ.FECHASEG)
					SELE CCP
					SET ORDE TO TAG TIEMPO
					IF SEEK(STR(M.XMES,2)+STR(M.XANIO,4))
						SCAN WHILE R_MES=M.XMES .AND. ;
							R_ANIO=M.XANIO .AND. ;
							!PAGADA
							DELE
						ENDS
					ENDIF
					STOR ARMA_FEC(ALQ.FECHASEG,M.XMES,M.XANIO) TO M.FECHAVE
					STOR .T. TO M.PAGADA,M.AUTORIZ
					STORE M.DETALLEOK TO M.DETALLE
					STOR "ND" TO M.COMPRRE
					STORE M.XANIO TO M.R_ANIO
					STORE M.XMES TO M.R_MES
					=AGRABAR("CCP")
					IF !EMPTY(ALQ.COMISION)
						STOR "NC" TO M.COMPRRE
						STOR M.MONTO*ALQ.COMISION/100 TO M.MONTO
						STOR M.EQUIVALE*ALQ.COMISION/100 TO M.EQUIVALE
						STOR .F. TO M.PAGADA
						STOR M.DETALLEOK+"๐Comis " TO M.DETALLE
						=AGRABAR("CCP")
					ENDIF
					SELE CCL
					=IAUD(ALLTRIM(M.DETALLEok)+" "+ALLTRIM(M.CODINM)+":"+STR(M.MONTO,XACDIGI,2))
				ENDIF
			ENDIF
			**** GENERA NOTAS DE CREDITO POR DEVOL. VOLUNT
			IF !EMPTY(ALQ.DTO_CONC)
				SELE CCL
				DELE FOR CCL.CODINM=M.CODINM .AND. ;
				LEFT(CCL.NUMERORE,3)="NCV" .AND. ;
				CCL.C_ANIO=M.C_ANIO .AND. ;
				CCL.C_MES=XMES
				STORE NUL TO M.ELDES
				IF M.FECHAVE<=ALQ.DTO_FEC1
					M.ELDES=ALQ.DTO_MON1
				ELSE
					IF M.FECHAVE<=ALQ.DTO_FEC2
						M.ELDES=ALQ.DTO_MON2
					ELSE
						IF M.FECHAVE<=ALQ.DTO_FEC3
							M.ELDES=ALQ.DTO_MON3
						ENDIF
					ENDIF
				ENDIF
				IF !EMPTY(M.ELDES)
					M.DETALL1=ALLTRIM(M.DETALLEOK)+"๐"+ALLTRIM(ALQ.DTO_CONC)
					=SWAP(@M.DETALL1,@M.DETALLE)
					M.C_CUOTA=NUL
					M.MONTO=M.ELDES
					STOR "NC" TO M.COMPRRE
					M.NUMERORE="NCV Nง "+ZERO(M.NUMDOC,8)
					M.RECIBO=SPACE(8)
					=AGRABAR("CCL")
					STORE M.XANIO TO M.R_ANIO
					STORE M.XMES TO M.R_MES
					M.DETALLE=M.DETALLEOK+"๐"+ALQ.DTO_CONC
					=AGRABAR("CCP")
					=SWAP(@M.DETALL1,@M.DETALLE)
				ENDIF
			ENDIF
			**** GENERA CARGAS POR ALQUILER
			IF HAYCAMBIO
				SELE CCL
				DELE FOR CCL.CODINM=M.CODINM .AND. ;
				LEFT(CCL.NUMERORE,3)="NDC" .AND. ;
				CCL.C_ANIO=M.C_ANIO .AND. ;
				CCL.C_MES=XMES
				SELE MIX
				* MIX.NU1-> 1.MONTO / 2. PORCENTAJE
				* MIX.NU3 -> EL MONTO O EL PORCENTAJE
				* MIX.NU2 -> MOMENTO DEL CALCULO 1. EN CALCULO - 2. EN PAGO
				* MIX.NU4-> 1. SIEMPRE 2. SI PAGA A TERMINO 33. SI PAGA RETRASADO
				* MIX.NU5 -> TIPO DE ALQUILER 1. TODOS 2. ASEGURADOS 3. NO ASEGURADOS

				SCAN FOR MIX.NU2=1
					IF MIX.NU5=1 .OR. ;
						(MIX.NU5=2 .AND. !EMPTY(ALQ.FECHASEG)) .OR. ;
						(MIX.NU5=3 .AND. EMPTY(ALQ.FECHASEG))
						IF MIX.NU1=1
							M.MONTO=MIX.NU3
						ELSE
							M.MONTO=M.MONTOOK*MIX.NU3/100
						ENDIF
						M.DETALL1=ALLTRIM(M.DETALLEOK)+"๐"+ALLTRIM(MIX.TEXTO1)
						=SWAP(@M.DETALL1,@M.DETALLE)
						M.C_CUOTA=100
						STOR "ND" TO M.COMPRRE
						M.NUMERORE="NDC Nง "+ZERO(M.NUMDOC,8)
						M.RECIBO=SPACE(8)
						=AGRABAR("CCL")
						SELE MIX
						=SWAP(@M.DETALL1,@M.DETALLE)
					ENDIF
				ENDSCAN
			ENDIF
			SELE ALQ
		ENDS
		=SAVDOC(5,M.NUMDOC)
		UNLO ALL
		=UNTALK()
		=UNWORK()
		=REOPALQ()
		=BEEP(3)
	ENDIF
	=RELEWIN('WIN')
ELSE
	=IAUDI()
ENDIF
RETURN MEN_LIN(BOTOM)
