* 旼 PROGRAMA 컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴커
*   APLICACION: SISTEMAS VARIOS                                             
*     ARCHIVO: IMPUTCCL.PRG                                                 
*        AUTOR: G. REINER                                                   
*  Date created: 11-16-92                                                   
*  Time created: 02:46:47pm                                                 
*     Copyright: 1992 by SISTEMAS INFORMATICOS S.R.L.                       
* 읕컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴켸
* REIMPUTA LOS PAGOS DE LOS CLIENTES
* SUMA TODO LO PAGADO
* CEREA LA VARIABLE CUOTA
* FALSEA LA VARIABLE PAGADO
* REPROCESA LAS OPERACIONES DE FACTURAS Y NOTAS DE DEBITO Y LES
* ASIGNA LOS PAGOS CORRESPONDIENTES
PARAMETER RE_CLIENTE,RE_QUETIPO
SELE CCL
=MEN_LIN("CALCULANDO MONTOS ABONADOS")
SET ORDER TO TAG CODCLI
IF SEEK(RE_CLIENTE)
	STORE NUL TO RE_SUMA,RE_RECIS,RE_CREDS,RE_ARRAY,RE_PUNTERO
	SET ORDER TO
	=FLOCK("CCL") .OR. FLOK("CCL")
	STORE RECC("CCL") TO CANTREC
	SORT ON COMPR,COMPRRE,NUMERORE TO PAGOS.TMP FOR CODCLI=RE_CLIENTE
	SELE CCL
	USE
	USE PAGOS.TMP ALIAS CCL IN 5 EXCL
	COPY TO COMPRAS.TMP FOR ESDEBE(CCL.COMPRRE)
	DELE FOR ESDEBE(CCL.COMPRRE)
	PACK
	CALC SUM(ABS(CCL.MONTO)) TO RE_SUMA

	IF !EMPTY(RE_SUMA)
		=MEN_LIN("BORRANDO IMPUTACION ANTERIOR")
		SELE 25
		USE COMPRAS.TMP ALIAS CPR EXCL
		REPL ALL CPR.CUOTA WITH NUL,;
		CPR.PAGADA WITH .F.
		INDEX ON NUMERORE TAG SHIT
		SELE CCL
		SCAN
			ELMONTO=CCL.MONTO
			IF TYPE("COMPR")="N"
				ELDOC=CCL.COMPR
			ELSE
				ELDOC=ALLTRIM(CCL.COMPR)
				ELDOC=SUBSTR(ELDOC,RAT(" ",ELDOC)+1)
			ENDIF
			SELE CPR
			SEEK ELDOC
			SCAN WHILE NUMERORE=ELDOC
				IF !CPR.PAGADA
					DIFERENCIA=CPR.MONTO-CPR.CUOTA
					IF DIFERENCIA>ELMONTO
						REPL CPR.CUOTA WITH CPR.CUOTA+M.ELMONTO
						STORE NUL TO ELMONTO
					ELSE
						REPL CPR.CUOTA WITH CPR.MONTO
						STORE ELMONTO-DIFERENCIA TO ELMONTO
						REPL CPR.PAGADA WITH .T.
					ENDIF
					IF EMPTY(ELMONTO)
						EXIT
					ENDIF
				ENDIF
			ENDSCAN
			SELE CCL
		ENDSCAN
		SELE CCL
		APPE FROM COMPRAS.TMP
		USE IN 25
		SELE CCL
		SET ORDER TO
		TMP=GENTMP()
		SORT ON FECHAOP,FECHAVE,NUMERORE TO (TMP)
		USE IN CCL
		=OPCCL()
		=FLOCK() .OR. FLOK()
		SET ORDER TO
		DELE FOR CCL.CODCLI=RE_CLIENTE .AND. RECNO()<=CANTREC
		APPE FROM (TMP)
		UNLO IN CCL
		=IAUD(ALLTRIM(RE_CLIENTE))
	ELSE
		=IAUD("NO "+RE_CLIENTE)
	ENDIF
ENDIF
RETURN REOPCCL()
