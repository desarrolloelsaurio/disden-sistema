PROCEDURE PERIBR
   TOTPER = 0
   TOTNET = 0
   TOTFAC = 0
   IF EMPTY(AT("PE",PER.CAG))
      SELECT SUM(M.MONTOBRU), SUM(M.MONTOOT3), SUM(MONTONET)
       INTO TOTNET, TOTPER, TOTFAC FROM FACTURA T ;
       WHERE T.FECHAEM = M.FECHAEM AND T.CODCLI = M.CODCLI
      IF PER.CONDIVA = "RI"
         TOTNET = TOTNET + M.MONTOBRU
         IF TOTNET >= 1000
            TOTPER = (TOTNET * 0.025) - TOTPER
            REPL MONTOOT3 WITH TOTPER FOR FACTURA = M.FACTURA AND CODCLI = M.CODCLI
         ENDIF
      ENDIF
      IF PER.CONDIVA = "MO"
         TOTFAC = TOTFAC + M.MONTONET
         IF TOTFAC >= 1000
            TOTFAC = (TOTFAC * 0.025) - TOTPER
            REPL MONTOOT3 WITH TOTPER FOR FACTURA = M.FACTURA AND CODCLI = M.CODCLI
         ENDIF
      ENDIF
   ENDIF
RETURN .T.
