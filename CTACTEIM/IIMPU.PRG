* ÚÄ PROGRAMA ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
* ³  APLICACION: ADMINISTRCION RAFULS                   ³
* ³    ARCHIVO: IIMPU.PRG                               ³
* ³       AUTOR: G. REINER                              ³
* ³ Date created: 12-11-92                              ³
* ³ Time created: 02:05:41pm                            ³
* ³    Copyright: 1992 by SISTEMAS INFORMATICOS S.R.L.  ³
* ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ
#DEFINE NUL    0                                 && NUL
#DEFINE BOTOM  "  "+repl("°",78)                 && BOTOM
TIPIMPU=BAR()
M.QUEIMP=Q_IMP(TIPIMPU)
RELE MIX_VARI,MIX_T1,MIX_R1,MIX_C1,MIX_COD,MIX_IND,MIX_R2,MIX_C2,MIX_ALIAS,MIX_CAMPO,MIX_LARGO
PUBL MIX_VARI,MIX_T1,MIX_R1,MIX_C1,MIX_COD,MIX_IND,MIX_R2,MIX_C2,MIX_ALIAS,MIX_CAMPO,MIX_LARGO
=MOVECENT(0,0,20,77,"INGCHE"," Ingreso de Impuesto "+m.QUEIMP+" "," "+alltrim(Janname)+" ")
@ 4,0 SAY PADC("DATOS DEL INGRESO",76,"*") COLO SCHE 3
@ 8,1 SAY "PERIODO" COLO SCHE 3
@ 10,1 SAY "A¥O" COLO SCHE 3
@ 12,1 SAY "CUOTA" COLO SCHE 3
@ 14,1 SAY "VENCIMIENTO" COLO SCHE 3
STORE DATE() TO M.FECHADE,M.FECHAVE
STORE INT(MONTH(DATE())/2)+1 TO M.PERIODO
STORE YEAR(DATE()) TO M.ANIO
STORE 1 TO CUOTA
STORE NUL TO MONTO,REN,MONTOORI
STORE SPACE(15) TO PARTIDA
@ 8,20 GET M.PERIODO ;
	MESS "PERIODO DEL IMPUESTO"
@ 10,20 GET M.ANIO ;
	MESS "A¥O CORRESPONDIENTE"
@ 12,20 GET M.CUOTA ;
	MESS "CUOTA DEL IMPUESTO"
@ 14,20 GET M.fechade ;
	MESS "FECHA DE VENCIMIENTO DEL IMPUESTO"
READ
IF LAST()#27 .AND. CONFIRMA("DATOS DEL INGRESO",.F.,16,20)
	NOMCAMPO=IIF(TIPIMPU=1,"INM.MUNICIPAL",IIF(TIPIMPU=2,"INM.INMOBILIARIO","INM.DIPOS"))
	M.ORDERTAG=IIF(TIPIMPU=1,"MUNICIPAL",IIF(TIPIMPU=2,"INMOBILIAR","DIPOS"))
	M.NUMDOC=GETDOC(8)
	M.MESS1=' - [ESC] PARA FIN'
	=IIMPUMSK()
	REN=REN+1
	STORE 1 TO A
	STORE STR(M.PERIODO,2)+RIGHT(STR(M.ANIO,4),2)+STR(CUOTA,1) TO M.LAEPOCA
	STORE .F. TO OUT
	DO WHILE .T.
		IF IIMPUING()
			=IIMPUGRA()
			REN=REN+1
			PSCION=AT("/",M.PARTIDA)
			IF !EMPTY(PSCION)
				PSCION=PSCION-1
				SELE INM
				SET ORDER TO TAG (ORDERTAG)
				SET NEAR ON
				SEEK LEFT(M.PARTIDA,PSCION)
				STORE M.PARTIDA TO LAPARTIDA
				=GRABACCP()
				SCAN WHILE !EOF()
					LACOSA=IIF(TIPIMPU=1,INM.MUNICIPAL,IIF(TIPIMPU=2,INM.INMOBILIARIO,INM.DIPOS))
					IF LACOSA#LAPARTIDA
						IF LEFT(LACOSA,PSCION)=LEFT(LAPARTIDA,PSCION)
							IF IIMPUING(.T.)
								=IIMPUGRA()
								REN=REN+1
							ELSE
								IF OUT
									EXIT
								ENDIF
							ENDIF
						ELSE
							EXIT
						ENDIF
					ENDIF
				ENDSCAN
				SET NEAR OFF
			ENDIF
		ELSE
			IF OUT
				EXIT
			ENDIF
		ENDIF
	ENDDO
	=SAVDOC(8,M.NUMDOC)
ENDIF
RELE MIX_VARI,MIX_T1,MIX_R1,MIX_C1,MIX_COD,MIX_IND,MIX_R2,MIX_C2,MIX_ALIAS,MIX_CAMPO,MIX_LARGO
=RELEWIN("INGCHE")
RETURN

* ÚÄ FUNCTION ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
* ³  Description:                                                            ³
* ³       AUTOR: G. REINER                                                   ³
* ³ Date created: 12-11-92                                                   ³
* ³ Time created: 02:54:02pm                                                 ³
* ³    Copyright: SISTEMAS INFORMATICOS S.R.L.                               ³
* ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
FUNCTION IIMPUING
	PARAMETER HAYALGO
	#DEFINE TEX_EFES " - [F2] Popup - [F3] B£squeda" && TEX_EFES
	#DEFINE ESCAMEN  " - [ESC] Para Men£"         && ESCAMEN
	STORE .T. TO IIMPU_SAL
	@ REN,0 SAY M.LINEA
	IF !HAYALGO
		STORE NUL TO M.MONTO
	ENDIF
	@ REN,1 GET M.FECHADE ;
		MESS "FECHA DE VENCIMIENTO DEL IMPUESTO"+ESCAMEN
	IF HAYALGO
		CLEA GETS
	ELSE
		READ
	ENDIF
	IF LAST()#27
		IF HAYALGO
			M.PARTIDA=IIF(TIPIMPU=1,INM.MUNICIPAL,IIF(TIPIMPU=2,INM.INMOBILIARIO,INM.DIPOS))
		ELSE
			STORE SPACE(15) TO M.PARTIDA
		ENDIF
		@ REN,10 GET M.PARTIDA ;
			WHEN GRL_F2("M.PARTIDA","N§ de Partida a Ingresar",REN,10,30,"INM","DOMICILIO",NOMCAMPO,"DOMICILIO",REN,26) ;
			MESS "Numero de Partida"+MESS1+TEX_EFES ;
			VALID OFF_F2()
		IF HAYALGO
			CLEA GETS
		ELSE
			READ
		ENDIF
		IF !EMPTY(M.PARTIDA)
			IF HAYALGO
				STORE M.PARTIDA TO M.PARTIDA1,M.PARTIDA2
			ELSE
				LABARRA=AT("/",M.PARTIDA)
				IF EMPTY(M.LABARRA)
					M.PARTIDA1=M.PARTIDA
					M.PARTIDA2=ALLTRIM(M.PARTIDA)+"/01"
				ELSE
					M.PARTIDA1=LEFT(M.PARTIDA,LABARRA-1)
					M.PARTIDA2=M.PARTIDA
				ENDIF
			ENDIF
			M.PARTIDA1=PADR(M.PARTIDA1,15)
			M.PARTIDA2=PADR(M.PARTIDA2,15)
			STORE .F. TO M.ENCONTRE
			IF XSEEK(M.PARTIDA2,"INM",M.ORDERTAG)
				STORE M.PARTIDA2 TO M.PARTIDA
				STORE .T. TO M.ENCONTRE
			ELSE
				IF XSEEK(M.PARTIDA1,"INM",M.ORDERTAG)
					STORE M.PARTIDA1 TO M.PARTIDA
					STORE .T. TO M.ENCONTRE
				ENDIF
			ENDIF
			IF ENCONTRE
				@ REN,10 GET M.PARTIDA
				CLEA GETS
				IF !XSEEK(M.PARTIDA+LAEPOCA,"CCI","CONTROL")
					NADA=LEFT(INM.DOMICILIO,35)
					@ REN,26 GET M.NADA
					CLEA GETS
					@ REN,62 GET M.MONTO ;
						PICT "9,999,999.99" ;
						MESS "Monto del Impuesto"
					IF HAYALGO
						CLEA GETS
					ELSE
						READ
						STORE M.MONTO TO M.MONTOORI
					ENDIF
				ELSE
					=CARTEL("IMPUESTO INGRESADO","DEBERA BORRARLO","Y LUEGO","INGRESARLO NUEVAMENTE")
					STORE .F. TO IIMPU_SAL
				ENDIF
			ELSE
				STORE .F. TO IIMPU_SAL
			ENDIF
		ELSE
			STORE .F. TO IIMPU_SAL
		ENDIF
	ELSE
		STORE .F. TO IIMPU_SAL
		STORE .T. TO OUT
	ENDIF
	IIMPU_SAL=IIF(IIMPU_SAL,last()#27 .AND. !EMPTY(M.MONTO),IIMPU_SAL)
	IF IIMPU_SAL
		IF !HAYALGO
			IIMPU_SAL=CONFIRM1("Impuesto Ingresado",.t.,20,40)
		ENDIF
	ENDIF
RETURN IIMPU_SAL

* ÚÄ FUNCTION ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿
* ³  Description:                                                            ³
* ³       AUTOR: G. REINER                                                   ³
* ³ Date created: 12-11-92                                                   ³
* ³ Time created: 02:53:07pm                                                 ³
* ³    Copyright: SISTEMAS INFORMATICOS S.R.L.                               ³
* ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´
FUNCTION IIMPUGRA
	M.MONTOANT=M.MONTO
	DO CASE
	CASE TIPIMPU=1
		M.ELPORC=INM.PORMUN
		M.SE_FACTURA=INM.FACMUN
	CASE TIPIMPU=2
		M.ELPORC=INM.PORINM
		M.SE_FACTURA=INM.FACINM
	CASE TIPIMPU=3
		M.ELPORC=INM.PORDIP
		M.SE_FACTURA=INM.FACDIP
	ENDCASE
	M.FACTURADA=IIF(M.SE_FACTURA,DATE(),{})
	M.MONTO=IIF(EMPTY(ELPORC),M.MONTO,M.MONTOORI*ELPORC/100)
	@ REN,62 GET M.MONTO ;
		PICT "9,999,999.99"
	CLEA GETS
	M.DETALLE=M.QUEIMP
	M.NUMERE=M.PARTIDA
	M.PERIO=LAEPOCA
	M.MONEDA=XAUSS
	M.CODINM=INM.CODINM
	M.INQUILINO=XSEEK(INM.CODINM,"ALQ","CODINM") .OR. SIGUEALQ(ALQ.CODCLI,INM.CODINM)
	M.CODCLI=IIF(M.INQUILINO,ALQ.CODCLI,INM.PROCOD)
	STORE DATE() TO M.FECHAOP
	STORE FECHADE TO M.FECHAVE
	M.COMPRRE='ND'
	M.CODINM=INM.CODINM
	=AGRABAR("CCI")
	IF !EMPTY(ELPORC)
		=XSEEK(LEFT(M.QUEIMP,2),'MIX','IMPCOD'))
		STORE LEFT(MIX.TEXTO1,3)+M.LAEPOCA TO M.DETALLE
		M.NUMERORE="NDT N§ "+ZERO(M.NUMDOC,8)
		M.COMPRRE="ND"
		M.COMPR=M.PARTIDA
		STORE XAUSS TO M.MONEDA
		STORE INM.CODINM TO M.CODINM
		M.C_MES=M.PERIODO
		M.C_ANIO=M.ANIO
		M.C_CUOTA=M.CUOTA
		IF M.INQUILINO                             && IMPUTA EN CTA CTE INQUILINO
			STORE ALQ.CODCLI TO M.CODCLI
			STORE M.CUOTA TO M.CUOTANT
			STORE NUL TO M.CUOTA
			STORE .T. TO MARKA
			=AGRABAR("CCL")
			STORE M.CUOTANT TO M.CUOTA
			SELE MIX
			SET ORDER TO TAG CMPTEX
			M.MONTOANT=M.MONTO
			M.MONTOOK=M.MONTO
			SCAN FOR MIX.NU2=1
				IF NU1=1
					M.MONTO=MIX.NU3
				ELSE
					M.MONTO=M.MONTOOK*MIX.NU3/100
				ENDIF
				M.DETALL1=ALLTRIM(M.DETALLE)+"ð"+ALLTRIM(MIX.TEXTO1)
				=SWAP(@M.DETALL1,@M.DETALLE)
				M.C_CUOTA=100
				STOR "ND" TO M.COMPRRE
				M.NUMERORE="NDT N§ "+ZERO(M.NUMDOC,8)
				STORE M.CUOTA TO M.CUOTANT
				STORE NUL TO M.CUOTA
				STORE .T. TO MARKA
				=AGRABAR("CCL")
				STORE M.CUOTANT TO M.CUOTA
				SELE MIX
				=SWAP(@M.DETALL1,@M.DETALLE)
			ENDSCAN
			M.MONTO=M.MONTOOK
		ENDIF
		STORE M.NUMDOC+1 TO M.NUMDOC
	ENDIF
	M.MONTO=M.MONTOANT
	IF REN>16
		=IIMPUMSK()
	ENDIF
RETURN .T.

FUNCTION IIMPUMSK
	M.LINEA=cuadro("4 0 18 0 1 8 15 35 12 ")
	C=1
	@ 1,C SAY "F. VENC."
	C=C+9
	@ 1,C SAY PADC("N§ PARTIDA",15)
	C=C+16
	@ 1,C SAY PADC("DOMICILIO",35)
	C=C+36
	@ 1,C SAY PADC("MONTO",12)
	REN=2
RETURN .T.

PROCEDURE GRABACCP
	*** PROBANDO - PERO PUEDE SER    ******************
	*** EN LA CUENTA DEL PROPIETARIO IMPUTA SIEMPRE ***
		DO CASE
	CASE TIPIMPU=1
		M.ELTX=INM.MUNIC
		M.SE_FACTURA=INM.FACMUN
	CASE TIPIMPU=2
		M.ELTX=INM.INMOC
		M.SE_FACTURA=INM.FACINM
	CASE TIPIMPU=3
		M.ELTX=INM.DIPOC
		M.SE_FACTURA=INM.FACDIP
	ENDCASE

	IF M.SE_FACTURA
		STORE INM.PROCOD TO M.PROCOD
		M.MONTO=M.MONTOORI
	M.DETALLE=M.QUEIMP
	M.NUMERE=M.PARTIDA
	M.PERIO=LAEPOCA
	M.MONEDA=XAUSS
	M.FECHAOP=DATE()
	M.CODINM=""
	M.COMPR=M.ELTX
		M.C_MES=M.PERIODO
		M.C_ANIO=M.ANIO
		=AGRABAR("CCP")	
		*** FIN PRUEBA
	ENDIF
RETURN .T.
