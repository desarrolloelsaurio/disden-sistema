* ษอออออออออออออออออออออออออออออออออออออออออป
* บ PROCEDIMIENTO : LRESI.PRG               บ
* บ COMENTARIO    : LISTA RESUMEN DE MUTUAL บ
* ฬอออออออออออออออออออออออออออออออออออออออออน
* บ AUTOR      : GOYO REINER                บ
* บ FECHA      : 05-01-94                   บ
* บ HORA       : 10:10:11am                 บ
* บ COPYRIGHT  : 1994 by GREGORIO REINER    บ
* ศอออออออออออออออออออออออออออออออออออออออออผ
#DEFINE FOUR   4                                 && FOUR
#DEFINE NUL    0                                 && NUL
#DEFINE BOTOM  "  "+repl("ฐ",78)                 && BOTOM
#DEFINE PAIP   "|"                               && PAIP
#DEFINE CRLF CHR(13)+CHR(10)                     && CRLF

STORE HORA_ULP(program()) TO ULPR
IF CHEQSEG()
	ACLA=PAIP+;
	PADC("Nง Orden",10)+PAIP+;
	PADC("Nง Afil.",LEN(LIQ.TEXTO3))+PAIP+;
	PADC("Paciente",30)+PAIP+;
	PADC("Prctica",30)+PAIP+;
	"Cant"+PAIP+;
	PADC("Honorarios",XACDIGI)+PAIP+;
	PADC("Gastos",XACDIGI)+PAIP+;
	PADC("Total",XACDIGI)+PAIP
	=IMPRESOR()
	******************************
	* CUENTA CANTIDAD DE REGISTROS
	CTMED=CUENTREG("PER","INTERCOD",".T.")
	******************************
	DIME TMAT[4],TMED[CTMED]
	STOR NUL TO CASOS,GASTOS,GALENOS,CATEGORIZ
	STOR NUL TO GALE_OS,GAST_OS,GALE_PAC,GAST_PAC,CATE_OS
	STOR NUL TO TOTAL,TMAT,TMED
	SELE PER
	SET ORDER TO TAG INTERNO
	COPY TO ARRAY LOSMED FIELDS CODCLI,CLIENTE

	STORE "งง" TO M.ELARANC
	LINEA=REPL("=",LEN(ACLA))
	SELE PRX
	SET ORDER TO TAG UNIDAD
	SELE PRA
	SET ORDER TO TAG CODPRA
	SELE LIQ
	SET RELA TO PRACTICA INTO PRA ADDI
	GO TOP
	ELTPR=TPR
	LAM=ALLTRIM(MUT.MUTUAL)
	LAM1=ALLTRIM(MUT.MUTUALABR)
	TT="Resumen de Prestaciขn Ambulatoria"+CRLF+;
	"OBRA SOCIAL:"+ALLTRIM(MUT.MUTUAL)+CRLF+;
	ALLTRIM(MUT.MUTUALABR)+CRLF+;
	ALLTRIM(SAYMIX(TPR,"TPRCOD"))
	**************************************
	=CABPRI()
	_PCOPIES=1
	PRINTJOB
	=CABPRI1()
	=TIT_LIN(3)
	***********************************
	SCAN
		STORE .F. TO HAYCAN
		IF ELTPR#TPR
			=SAYFIN()
			EJECT PAGE
			ELTPR=TPR
			TT="Resumen de Prestaciขn Ambulatoria"+CRLF+;
			"OBRA SOCIAL:"+LAM+CRLF+;
			LAM1+CRLF+;
			ALLTRIM(SAYMIX(ELTPR,"TPRCOD"))
			=cabpri1()
			=TIT_LIN(3)
		ENDIF
		=CHKLIN()
        STORE LIQ.TPR TO M.TPR
        STORE LIQ.NUMERO TO M.NUMERO
		STORE LIQ.PRACTICA TO M.PRACTICA
		STORE LIQ.PRXCOD TO M.PRXCOD
        STORE NUL TO M.P_GAL,M.P_GAS,M.P_RAD,M.P_REM,M.P_DES,M.P_CON
        STORE NUL TO M.O_GAL,M.O_GAS,M.O_RAD,M.O_REM,M.O_DES,M.O_CON
        STORE NUL TO M.T_GAL,M.T_GAS,M.T_RAD,M.T_REM,M.T_DES,M.T_CON
		? PAIP
		?? PADR(ALLTRIM(ORDEN),10)
		?? PAIP
		?? PADR(ALLTRIM(TEXTO3),20)
		?? PAIP
		?? PROP(CLIENTE)
		?? PAIP
		?? SAYPR1(PRACTICA) PICT "@R 99.99.99!"
		?? PAIP
		?? LEFT(PROP(PRA.PRACTICA),20)
		?? PAIP
		ELMUTUAL=LIQ.TEXTO1
		ELPLAN=LEFT(LIQ.TEXTO2,5)
		******************************
		*** BUSCA ARANCEL DEL PLAN ***
		******************************
		=XSEEK(ELMUTUAL+ELPLAN,"MUT","CODPLAN")
*		IF MUT.TAR#M.ELARANC
			ELARANC=MUT.TAR
			**********************************
			*** BUSCA PORCENTAJES DEL PLAN ***
			**********************************
			=XSEEK(ELMUTUAL+ELPLAN+"UNI","MUX","TIPO")
			ALPAC=MUX.AC_PACIEN
			ALMUT=MUX.AC_MUTUAL
*		ENDIF
		***********************************************
		*** VERIFICA SI HAY VARIAS PRACTICAS REPETIDAS
		*** PARA SUMAR DIRECTAMENTE AL TOTAL
		***********************************************
        IF XSEEK(LIQ.PRACTICA+LIQ.PRXCOD+LIQ.PRACTICA,"PRX","UNIPRAD")
			STORE PRX.CANTIDAD+1 TO M.CTDD
		ELSE
			STORE 1 TO M.CTDD
		ENDIF
		***********************************************
		?? STR(M.CTDD,4)
		?? PAIP

		*** PROBANDO ACA
		GLN=PRA.CANTIDAD1*M.CTDD*;
		SAYGRL(ELARANC+PRA.UNIDAD1,"MIX","ARACOD","MIX.NU1")
		GLN_PARC=GLN
		M.T_GAL=M.T_GAL+GLN
		GLN=GLN*ALMUT/100
		M.P_GAL=M.P_GAL+GLN_PARC*ALPAC/100
		M.O_GAL=GLN
		?? STR(GLN,XACDIGI,2)
		?? PAIP

		*** PROBANDO ACA TAMBIEN
		GTS=PRA.CANTIDAD2*;
		M.CTDD*;
		SAYGRL(ELARANC+PRA.UNIDAD2,"MIX","ARACOD","MIX.NU1")
		GTS_PARC=GTS
		M.T_GAS=M.T_GAS+GTS
		GTS=GTS*ALMUT/100
		M.P_GAS=M.P_GAS+GTS_PARC*ALPAC/100
		M.O_GAS=GTS
		?? STR(GTS,XACDIGI,2)

		?? PAIP
		PARC=GTS+GLN
		?? STR(PARC,XACDIGI,2)
		?? PAIP
		GALE_OS=GALE_OS+GLN
		GAST_OS=GAST_OS+GTS
		**** SE GUARDA EL MATERIAL PARA DESPUES
		IF !EMPTY(PRA.UNIDAD3)
		    STORE .T. TO HAYCAN
			STORE PRA.UNIDAD3 TO M.PRAUNID3
			STORE PRA.TIPO3 TO M.PRATIPO3
            STORE M.CTDD TO M.CANTIOR,M.CANTI3
		ELSE
		    STORE .F. TO HAYCAN
			STORE "" TO M.PRAUNID3,M.PRATIPO
		ENDIF
		*******
		=HAYCAT()
		**** CONTRASTE ?
		IF !EMPTY(PRA.CONTRASTE)
			=SAYCONT()
		ENDIF
		********** COMPONENTES
		SELE PRX
		SET ORDER TO TAG CODPRX1
		IF SEEK(LIQ.PRACTICA+LIQ.PRXCOD)
			SCAN WHILE PRX.CODPRA=LIQ.PRACTICA .AND. ;
				PRX.CODPRX=LIQ.PRXCOD
				IF EMPTY(PRX.UNIPRA) .OR. ;
					PRX.UNIPRA#LIQ.PRACTICA
					IF PRX.TIPO#"PRA"
						=SAYMAT(PRX.UNIDAD,PRX.TIPO)
					ELSE
						=SAYPRA(PRX.UNIPRA)
					ENDIF
					=CHKLIN()
				ENDIF
			ENDSCAN
		ENDIF
		SELE LIQ
		**** MATERIAL ?
		IF !EMPTY(PRAUNID3)
			=SAYMAT(PRAUNID3,PRATIPO3,.T.)
		ENDIF
		=IIF(XSEEK(M.TPR+STR(M.NUMERO)+M.PRACTICA+M.PRXCOD,"LIX","NUMERO"),;
		AGRABAR1("LIX",.F.,.T.),;
		AGRABAR("LIX",.F.,.F.,.T.))
		SELE LIQ
	ENDSCAN
	=SAYFIN()
	ENDP
	EJECT PAGE
	=FINIMP()
	=IAUD("")
ELSE
	=IAUDI()
ENDIF
RETURN

FUNCTION SAYMAT
	PARAMETER SA_UNID,SA_TIPO,SA_VIENE
	=XSEEK(SA_UNID,"MIX",SA_TIPO+"COD")
	? PAIP
	?? SPACE(10)
	?? PAIP
	?? SPACE(LEN(LIQ.TEXTO3))
	?? PAIP
	?? SPACE(30)
	?? PAIP
	?? SPACE(9)
	?? PAIP
	?? PROP(MIX.TEXTO1)
	?? PAIP
IF !SA_VIENE
	M.CANTI3=PRX.CANTIDAD
ELSE
   M.CANTI3=M.CANTIOR
ENDIF
	?? STR(M.CANTI3,4)
	?? PAIP
	?? SPACE(XACDIGI)
	?? PAIP
	IF XSEEK(ELMUTUAL+ELPLAN+SA_TIPO,"MUX","TIPO")
	   GTSOR=M.CANTI3*MIX.NU1
	   GTS=M.CANTI3*MIX.NU1*MUX.AC_MUTUAL/100
	ELSE
     STORE M.CANTI3*MIX.NU1 TO GTS,GTSOR
 	ENDIF
	?? STR(GTS,XACDIGI,2)
	?? PAIP
	?? STR(GTS,XACDIGI,2)
	?? PAIP
	GAST_OS=GAST_OS+GTS
	INDICE=SAYTIPO(SA_TIPO)
	TMAT[INDICE]=TMAT[INDICE]+GTS
	DO CASE
	CASE INDICE=1
		M.O_DES=M.O_DES+GTS
		M.P_DES=M.P_DES+GTSOR*MUX.AC_PACIEN/100
		M.T_DES=M.T_DES+GTSOR
	CASE INDICE=2
		M.O_RAD=M.O_RAD+GTS
		M.P_RAD=M.P_RAD+GTSOR*MUX.AC_PACIEN/100
		M.T_RAD=M.T_RAD+GTSOR
	CASE INDICE=3
		M.O_REM=M.O_REM+GTS
		M.P_REM=M.P_REM+GTSOR*MUX.AC_PACIEN/100
		M.T_REM=M.T_REM+GTSOR
	CASE INDICE=4
		M.O_GAS=M.GAS+GTS
		M.P_GAS=M.P_GAS+GTSOR*MUX.AC_PACIEN/100
		M.T_GAS=M.T_GAS+GTSOR
	ENDCASE
RETURN .T.

FUNCTION SAYCONT
	? PAIP
	?? SPACE(10)
	?? PAIP
	?? SPACE(LEN(LIQ.TEXTO3))
	?? PAIP
	?? SPACE(30)
	?? PAIP
	?? SPACE(9)
	?? PAIP
	?? PADR("Contraste "+ALLTRIM(STR(PRA.CONTRASTE))+" %",20)
	?? PAIP
	?? SPACE(4)
	?? PAIP
	GLN=GLN_PARC*PRA.CONTRASTE/100
	M.T_CON=M.T_CON+GLN
	M.O_CON=M.O_CON+GLN*ALMUT/100
	M.P_CON=M.P_CON+GLN*ALPAC/100
	GLN=GLN*ALMUT/100
	?? STR(GLN,XACDIGI,2)
	?? PAIP
	GTS=GTS_PARC*PRA.CONTRASTE/100
	M.T_CON=M.T_CON+GTS
	M.O_CON=M.O_CON+GTS*ALMUT/100
	M.P_CON=M.P_CON+GTS*ALPAC/100
	GTS=GTS*ALMUT/100
	?? STR(GTS,XACDIGI,2)
	?? PAIP
	?? STR(GTS+GLN,XACDIGI,2)
	?? PAIP
	GAST_OS=GAST_OS+GTS
	GALE_OS=GALE_OS+GLN

RETURN haycat()

FUNCTION SAYPRA
	PARAMETER LAPRA
	? PAIP
	?? SPACE(10)
	?? PAIP
	?? SPACE(LEN(LIQ.TEXTO3))
	?? PAIP
	?? SPACE(30)
	?? PAIP
	?? SAYPR1(LAPRA) PICT "@R 99.99.99!"
	?? PAIP
	=XSEEK(LAPRA,"PRA","CODPRA")
	?? LEFT(PROP(PRA.PRACTICA),20)
	?? PAIP
	M.CTDD=PRX.CANTIDAD
	?? STR(M.CTDD,4)
	?? PAIP
	GLN=PRA.CANTIDAD1*M.CTDD*;
	SAYGRL(ELARANC+PRA.UNIDAD1,"MIX","ARACOD","MIX.NU1")*;
	(ALMUT/100)
	?? STR(GLN,XACDIGI,2)
	?? PAIP
	GTS=PRA.CANTIDAD2*;
	M.CTDD*;
	SAYGRL(ELARANC+PRA.UNIDAD2,"MIX","ARACOD","MIX.NU1")*;
	(ALMUT/100)
	?? STR(GTS,XACDIGI,2)
	?? PAIP
	?? STR(GTS+GLN,XACDIGI,2)
	?? PAIP
	GAST_OS=GAST_OS+GTS
	GALE_OS=GALE_OS+GLN
	=HAYCAT()
	*
	IF !EMPTY(PRA.UNIDAD3)
		=SAYMAT(PRA.UNIDAD3,PRA.TIPO3)
	ENDIF
	*
RETURN

FUNCTION SAYPR1
PARAMETER PRA1
IF EMPTY(RIGHT(PRA1,1))
	RETURN PRA1
ENDIF
IF RIGHT(PRA1,1)="A" .OR. ;
	RIGHT(PRA1,1)="B"
RETURN PRA1
ENDIF
RETURN LEFT(PRA1,6)+" "

FUNCTION HAYCAT
	** BUSCA MEDICO PARA CATEGORIZACION
	IF XSEEK(LIQ.INTERNO,"PER","INTERCOD")
		CAT=VAL(PER.DETALLE)
		LACAT=GLN*CAT/100
		CATEGORIZ=CATEGORIZ+LACAT
		POSINTER=ASCAN(LOSMED,LIQ.INTERNO)
		POSINTER=(POSINTER+1)/2
		TMED[POSINTER]=TMED[POSINTER]+LACAT
	ENDIF
RETURN .T.

FUNCTION SAYFIN
	? M.LINEA
	*** BRUTO
	LAPOS=LEN(M.LINEA)-(XACDIGI+1)*3
	? "Totales Brutos:"
	?? STR(GALE_OS,XACDIGI,2) AT LAPOS
	?? PAIP
	?? STR(GAST_OS,XACDIGI,2)
	?? PAIP
	?? STR(GALE_OS+GAST_OS,XACDIGI,2)
	?? PAIP
	*** CATEGORIZACION
	? "Categorizaciขn:"
	?? STR(CATEGORIZ,XACDIGI,2) AT LAPOS
	?? paip
	*** TOTALES
	? "Totales:"
	?? STR(CATEGORIZ+GALE_OS,XACDIGI,2) AT LAPOS
	?? PAIP
	?? STR(GAST_OS,XACDIGI,2)
	?? PAIP
	?? STR(GALE_OS+GAST_OS+CATEGORIZ,XACDIGI,2)
	?? PAIP
	STOR NUL TO CASOS,GASTOS,GALENOS,CATEGORIZ
	STOR NUL TO GALE_OS,GAST_OS,GALE_PAC,GAST_PAC
	**
	* SAYFIN 1
	?
	?
	? "MATERIAL DESCARTABLE:"
	?? STR(TMAT[1],XACDIGI,2)
	? "MATERIAL RADIACTIVO :"
	?? STR(TMAT[2],XACDIGI,2)
	? "MEDICAMENTOS        :"
	?? STR(TMAT[3],XACDIGI,2)
	? "UNIDADES            :"
	?? STR(TMAT[4],XACDIGI,2)
    ?
? "CATEGORIZACION:"
FOR XA=1 TO ALEN(LOSMED,1)
IF !EMPTY(TMED[XA])
   ? LOSMED[XA,2]
   ?? ":"
   ?? STR(TMED[XA],XACDIGI,2)
ENDIF
NEXT
STORE NUL TO TMED,TMAT
RETURN .T.

FUNCTION CHKLIN
	IF _PLINENO>63
		=FIN_LIN(3,NUL)
		=cabpri1()
		=TIT_LIN(FOUR)
	ENDI
RETURN .T.

