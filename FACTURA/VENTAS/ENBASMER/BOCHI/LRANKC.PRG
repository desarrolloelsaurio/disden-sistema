PARAMETER PORPAN,ELTIPO,LRANK
*******************************
* LRANK: 	1. COMPLETO
*			2. POR AGRUPACION
*			3. POR ZONA
* ELTIPO:	1. FACTURAS
*			2. NOTAS DE DEBITO
*			3. NOTAS DE CREDITO
*******************************
if !pideclav(1)
	return
endif
STORE .T. TO M.OK
STORE HORA_ULP(PROGRAM()) TO M.ULPR
ELNODOC=IIF(ELTIPO="F","FACTURAS",IIF(ELTIPO="D","NOTAS DE DEBITO","NOTAS DE CREDITO"))
DO CASE
CASE M.LRANK=1
	TT=ELNODOC
	STORE ".T." TO M.FISC
CASE M.LRANK=2
    =OPCAG()
	STORE NUL TO M.RESPUESTA
	STORE 2 TO M.FILCAG
	STORE "" TO FISC,TT,TTCAG,QUECAG
	=QW_CAG(.F.,.F.,"PER.CAG")
	TT="Por Agrupación "+TTCAG
	IF !EMPTY(QUECAG) .AND. ;
			QUECAG#".F."
		FISC=QUECAG
	ELSE
		=NOSELEC("AGRUPACION")
		STORE .F. TO M.OK
	ENDIF
CASE M.LRANK=3
	=OPZON()
	=OPCLI()
	STORE NUL TO M.RESPUESTA
	IF ELIZON("a Listar",-1,1)
		TT="Clientes de Zona:"+alltrim(mix.texto1)
		FISC="LEFT(per.texto1,2)='"+left(mix.texto2,2)+"'"
	ELSE
		=NOSELEC("ZONA")
		STORE .F. TO M.OK
	ENDIF
ENDCASE
IF M.OK
	STORE {} TO M.FECINI,M.FECFIN
	IF ENTRE_FE("a Listar")
	    ELFI1=IIF(ELTIPO="F","(EMPTY(FAC.TIPO) .OR. FAC.TIPO='FA')",IIF(ELTIPO="D","FAC.TIPO='ND'","FAC.TIPO='NC'"))
	    FISC=QW_FISC(FISC,ELFI1)
		FISC=FISC+" .AND. BETW(FAC.FECHAEM,{"+;
			DTOC(M.FECINI)+;
			"},{"+;
			DTOC(M.FECFIN)+"})"
		tt1="Entre el "+dtoc(m.fecini)+" y el "+dtoc(m.fecfin)
		=OPCLI()
		=OPFAC()
		=WORKING()
		=DOTALK()
		SELE FAC
		SET ORDER TO 
   		   IF M.LRANK#1
			  SET ORDER TO TAG CODCLI IN PER
			  SET RELA TO CODCLI INTO PER
		   ENDIF
		SELE FAC
		TMP=GENTMP()
		TMP1=GENTMP()
		=FLOCK() .OR. FLOK()
		SORT ON CODCLI TO (TMP) FOR &FISC
		UNLO IN FAC
		=PRXAREA(.T.)
		USE (TMP) ALIAS TMP EXCL
		TOTAL ON CODCLI TO (TMP1)
		=PRXAREA(.T.)
		USE (TMP1) ALIAS TEMPORAL
		=UNTALK()
		=UNWORK()
	    INDEX ON MONTOBRU TAG ARTICULO DESC
		SELE PER
		SET ORDER TO TAG CODCLI
		SELE TEMPORAL
		SET ORDER TO TAG ARTICULO
		SET RELA TO CODCLI INTO PER
		if porpan
		   REPO FORM RANKING2 PREV
		else
   		   REPO FORM RANKING2 TO PRIN NOCONSOLE
		endif
		=OFF_TMP()
		=OFF_RELA()
	ELSE
		=NOSELEC("FECHA")
	ENDIF
ENDIF
UNLO ALL
RETURN