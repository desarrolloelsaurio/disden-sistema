procedure presup
para pordonde
store 0 to descuento
store space(20) to m.clietxt, m.pagotxt
store date() to m.chafe
store 1 to m.maymin, m.condiva
do presup.spr
if last()#27
	=opmer()
	SET ORDER TO TAG ARTICULO
	CREATE CURSOR FAC1 ;
		(ARTICULO C(10),;
		DENOM C(30),;
		MONTOOR N(12,2),;
		NOINS N(12,2),;
		GRAVADO N(12,2),;
		IVA N(14,4),;
		TOTAL N(12,2),;
		CANTIDAD N(5))
	FOR A=1 TO 80
	 	APPE BLAN
	ENDFOR
	GO TOP
	DEFI WIND WIN FROM 1,1 TO 37,80
	SET RELA TO ARTICULO INTO MER
	on key label F10 keyb chr(23)
	ON KEY LABEL F2 DO ELIMER1
	ON KEY LABEL F3 DO ELIMER2 

	BROW FIEL ;
		CANTIDAD:P="9999":V=AJCAN() ,;
		ARTICULO:P="@!":14:W=(CANTIDAD>0):V=MEROK() ,;
		DENOM:R:H="DESCRIPCION" :40,;
		GRAVADO:P="99,999.99":W=(!EMPTY(ARTICULO)):V=GRAOK(),;
		IVA :R:P="9999.99" ,;
		TOTAL:R:P="99,999.99" ;
		TITL " -- PRESUPUESTO  --- " ;
		FONT "ARIAL",9 ;
		COLOR RGB(255,0,0,255,255,255) ;
	WIND WIN
	RELE WIND WIN
	ON KEY LABEL F10 
	ON KEY LABEL F2
	ON KEY LABEL F3
	if last()#27
		sum total to m.montoto
		define window desc from 10,20 to 15,75
		acti wind desc
		@ 1,1 say "TOTAL       : "
		@ row(),col() say m.montoto pict "999,999,999.99"
*		@ 2,1 say "% DESCUENTO : " get  descuento pict "@Z 999.99"
		read
		clea wind desc
		if last()#27
			inde on denom tag a for !empty(articulo)
			set orde to tag a
			if pordonde="P"
				repo form LPRESUP PREV
			else
				repo form LPRESUP TO PRIN PROM NOCO
			endif
		endif
	endif
	use in fac1
endif
return


FUNCTION MEROK
REPL FAC1.ARTICULO WITH ZERO(VAL(FAC1.ARTICULO),10)
IF XSEEK(FAC1.ARTICULO,"MER","ARTICULO")
	REPL FAC1.GRAVADO WITH SAYPRE(IIF(M.MAYMIN=2,"-","+"))
	REPL FAC1.DENOM WITH MER.MERCA
	IF EMPTY(FAC1.CANTIDAD)
		REPL FAC1.CANTIDAD WITH 1
	ENDIF
	=AJPREC()
ENDIF
RETURN .T.

FUNCTION GRAOK
IF !EMPTY(FAC1.GRAVADO)
	RETURN AJPREC()
ENDIF
RETURN .F.

FUNCTION AJPREC
REPL FAC1.IVA WITH FAC1.GRAVADO*iif(condiva=1, IVA18, iif(condiva=2, IVA18, iif(condiva=3, IVA27, 0)))
REPL FAC1.TOTAL WITH (FAC1.IVA+FAC1.GRAVADO)*FAC1.CANTIDAD
RETURN .T.

FUNCTION AJPREC2
REPL FAC1.MONTOOR WITH FAC1.GRAVADO
IF M.CONDIVA=4
	REPL FAC1.IVA WITH 0
ELSE
	REPL FAC1.IVA WITH FAC1.GRAVADO*IVA18
ENDIF
IF M.CONDIVA=3
	REPL FAC1.NOINS WITH FAC1.GRAVADO*IVA09
ELSE
	REPL FAC1.NOINS WITH 0
ENDIF
REPL FAC1.TOTAL WITH (FAC1.GRAVADO+FAC1.IVA+FAC1.NOINS)*FAC1.CANTIDAD
RETURN .T.

FUNCTION AJCAN
IF !EMPTY(FAC1.ARTICULO)
	RETURN AJPREC()
ENDIF
RETURN .T.

FUNCTION ELIMER1
PUSH KEY CLEA
STORE NUL TO RESPUESTA
IF ELIMER("a Facturar",-1,1)
	SELE FAC1
	REPL FAC1.ARTICULO WITH MER.ARTICULO
	REPL FAC1.DENOM WITH MER.MERCA
	pop key
	RETURN MEROK()
ENDIF
SET ORDER TO TAG ARTICULO IN MER
SELE FAC1
POP KEY
RETURN .T.

FUNCTION ELIMER2
PUSH KEY CLEA
IF SEEKTECX(LEN(MER.MERCA),"MER","MER.MERCA","MER.ARTICULO","MERCA","FAC1",.F.,1,1,.T.)
	SELE FAC1
	REPL FAC1.ARTICULO WITH MER.ARTICULO
	REPL FAC1.DENOM WITH MER.MERCA
	pop key
	RETURN MEROK()
ENDIF
SET ORDER TO TAG ARTICULO IN MER
SELE FAC1
POP KEY
RETURN .T.
