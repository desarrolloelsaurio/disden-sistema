ya = seco()
CLOS DATA
ON ERROR
SET EXCLUSIVE OFF
SET SAFETY OFF
*CAMINAN = "\\BOCHI\ZIP\"
CAMINAN = "F:\SISTEMAS\VENTAS\"
SET TALK ON
CLEAR
SELE 0
USE C:\FINDE\CCCLI  ALIAS NCCCLI  EXCL
ZAP
SELE 0
USE C:\FINDE\CCCLIH ALIAS NCCCLIH EXCL
ZAP
APPEND FROM (CAMINAN+"VENTASA\CCCLIH") for !dele()
VIEJOS = RECC()
APPEND FROM (CAMINAN+"VENTASA\CCCLI")  FOR COMPRRE<>"SA" AND COMPRRE<>"SD" and !dele()
SCATTER MEMVAR BLANK

SET EXCLUSIVE OFF
SET SAFETY OFF
SET DELETE ON
SET TALK OFF
sele 0
USE F:\SISTEMAS\VENTAS\VENTASA\PERSONAS ALIAS PER ORDER CODCLI
count to i
dime loscl(i-1)
a=1
go top
skip
scan rest
	loscl(a)=codcli
	a=a+1
ends
**COPY TO ARRAY LOSCL FIEL CODCLI FOR FILTRO="C" AND !DELE()
use 
ON ERROR DO ELERROR WITH ERROR( )
FOR I=2 TO ALEN(LOSCL)
	M.CLI = LOSCL(I)
	DO CALCUSAL WITH M.CLI
NEXT
wait str(seco()-ya) wind 
RETURN

FUNCTION CALCUSAL
	PARAMETER ELCLI
	SELE NCCCLIH
	
	M.MONTO    = CALCULIN(1,"MONTO",    ELCLI, 1)
	M.COMISION = CALCULIN(2,"COMISION", ELCLI, VIEJOS)
	M.COMISIP  = CALCULIN(3,"COMISIP" , ELCLI, VIEJOS)

	IF ABS(M.MONTO)>0.10
		? ELCLI
		??" ----> "
		??M.MONTO
		STORE ELCLI TO CODCLI
		STORE IIF(M.MONTO>0, "SD", "SA") TO M.COMPRRE
		STORE DATE() TO FECHAOP, FECHAVE, FECHA
		STORE "Saldo al "+DTOC(DATE()) TO DETALLE
		STORE ABS(M.MONTO) TO M.CUOTA, M.MONTO
		INSERT INTO NCCCLI FROM MEMV
	ENDIF
RETURN

PROCEDURE ELERROR
PARA ELNU
IF ELNU=39
	IF M.Q=1
		REPLACE MONTO WITH 0 FOR MONTO>1000000
	ENDIF
	IF M.Q=2
		REPLACE COMISION WITH 0 FOR COMISION >1000000
	ENDIF
	IF M.Q=3
		REPLACE COMISIP WITH 0 FOR COMISIP >1000000
	ENDIF
	RETRY
ELSE
	ON ERROR
	RETRY
ENDIF
RETURN

FUNCTION CALCULIN
PARA NQ, LAVA, CUALCLI, DESDE
	ELRESU = 0
	M.Q = NQ
	CALC SUM(EVAL(LAVA)) TO Z_debe  FOR (comprre ="FA" .OR.  comprre ="ND" ) .AND. CODCLI=CUALCLI .AND. RECN()>DESDE
	CALC SUM(EVAL(LAVA)) TO Z_haber FOR (comprre<>"FA" .AND. comprre<>"ND" ) .AND. CODCLI=CUALCLI .AND. RECN()>DESDE
	STORE Z_debe-Z_haber TO ELRESU
RETURN ELRESU