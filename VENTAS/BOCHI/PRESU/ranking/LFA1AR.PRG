FUNCTION LFA1AR
#DEFINE BOTOM  "  "+repl("°",78)                 && BOTOM
#DEFINE ABA    "Abriendo Base de "               && ABA
#DEFINE PICUMAX "9,999,999,999,999.99"           && PICUMAX
#DEFINE PICUMA1 "9,999,999,999,999"              && PICUMA1
#DEFINE PAIP   "|"                               && PAIP
#DEFINE FOLC  ".F."                              && FOLC
PARAMETER PORPAN
=OPCLI()
=OPMER()
STORE 0 TO M.RESPUESTA
IF ELIMER("a listar",-1,1)
	STORE DATE() TO FECINI, FECFIN
	IF ENTRE_FE("Fechas a listar ")
		STORE 0 TO M.RESPUESTA
		STORE 2 TO M.FILCAG
		STORE "" TO FISC,TT,TTCAG,QUECAG
		=QW_CAG(.F.,.F.,"PER.CAG")
		IF QUECAG#".F."
			SELE PER
      		SET ORDER TO TAG CLIENTES
      		FISC=QUECAG
      		TT=TTCAG
		ELSE
      		STORE .F. TO M.OK
      		=NOSELEC("AGRUPACION")
		ENDIF
   		=DOTALK()
   		=WORKING()
    	=OPFAC()
    	SET ORDER TO TAG CODCLI IN PER
    	SELE FAC
    	SET ORDER TO TAG FACTURA 
    	SET RELA TO CODCLI INTO PER
    	SELE FAX
    	SET ORDER TO
    	TMP=GENTMP()
    	SET RELA TO FACTURA INTO FAC ADDI
    	SORT ON FACTURA TO (TMP) FOR ARTICULO=MER.ARTICULO  ;
       		AND BETWEEN(FAC.FECHAEM,FECINI,FECFIN) ;
       		AND &FISC ;
       		FIELD PER.CLIENTE,FAX.GRAVADO,FAX.CANTIDAD,FAX.NOINS,PER.NU1
    	=UNLO_PRX("FAX",TMP)
    	REPL ALL NU1 WITH 1
    	REPL ALL NOINS WITH GRAVADO
    	REPL ALL GRAVADO WITH GRAVADO*CANTIDAD
    	INDEX ON CLIENTE+STR(NOINS,10,2) TAG CLIENTE
    	SET ORDER TO TAG CLIENTE
    	TMP1=GENTMP()
    	TOTAL ON CLIENTE+STR(NOINS,10,2) FIELD GRAVADO,CANTIDAD,NU1 TO (TMP1)
    	=PRXAREA(.T.)
    	USE (TMP1) 
    	TT="Facturas del Artículo "+allt(mer.merca)+" ("+mer.articulo+")"+ ;
          CHR(13)+CHR(10)+"Entre el "+DTOC(fecini)+" y el "+DTOC(fecfin)+ ;
          CHR(13)+CHR(10)+ttcag
     	IF PORPAN
        	 REPO FORM LFA1AR PREV
	    ELSE
    	     REPO FORM LFA1AR NOCONSOLE TO PRIN PROM 
    	ENDIF
    	=OFF_RELA()
    	=OFF_TMP()
    	=UNTALK()
    	=UNWORK()
	ENDIF
ENDIF
RETURN MEN_LIN(BOTOM)