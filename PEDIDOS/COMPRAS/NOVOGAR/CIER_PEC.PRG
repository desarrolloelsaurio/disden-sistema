#DEFINE ENTERCON "PULSE [ENTER] PARA CONTINUAR"  && ENTERCON
STORE HORA_ULP(PROGRAM()) TO ULPR
IF CHEQSEG()
   IF EMPTY(PEC.FECHAENT)
   =WORKING()
   SELE PEC
   SCAT MEMV
   IF XSEEK(M.PEDIDO+M.PROCOD,'PE1','PEDIDO')
      SELE PE1
      SCAN WHILE PE1.PEDIDO=M.PEDIDO .AND. ;
           PE1.PROCOD=M.PROCOD
         IF PE1.CANTIDAD>PE1.ENTREGADO
            =CARTEL("LA NOTA DE PEDIDO N§"+PEC.PEDIDO,;
              "DEL PROVEEDOR "+ALLTRIM(PRO.PROVEEDOR),;
              "CONTIENE PENDIENTES Y NO SE PUEDE CERRAR EN ESAS CONDICIONES",;
              ENTERCON)
            =IAUD(PEC.PEDIDO+" NO")
            =UNWORK()
            RETURN MEN_LIN(BOTOM)
         ENDIF
      ENDSCAN
      =UNWORK()
      =CARTEL("LA NOTA DE PEDIDO N§"+PEC.PEDIDO,;
        "DEL PROVEEDOR "+ALLTRIM(PRO.PROVEEDOR),;
        "FIGURA COMO COMPLETAMENTE CANCELADA",;
        ENTERCON)
      IF CONFIRMA("CERRAR LA PEDIDO N§"+PEC.PEDIDO+" DE "+ALLTRIM(PRO.PROVEEDOR),.T.,10,0)
         M.FECHAFIN=INFEC("WIN"," Cierre del Pedido ")
         SELE PEC
         =lock("PEC") .OR. LOK("PEC")
         REPL FECHAENT WITH M.FECHAFIN
         =IAUD(PEC.PEDIDO+'|'+PEC.PROCOD+'|'+DTOC(M.FECHAFIN))
      ENDIF
   ENDIF
   ELSE
            =CARTEL("LA NOTA DE PEDIDO N§"+PEC.PEDIDO,;
         "DEL PROVEEDOR "+ALLTRIM(PRO.PROVEEDOR),;
         "FIGURA TERMINADA DE RECIBIR EL DIA "+DTOC(PEC.FECHAENT),;
         ENTERCON)
ENDIF
ELSE
   =IAUDI()
ENDIF
RETURN MEN_LIN(BOTOM)
