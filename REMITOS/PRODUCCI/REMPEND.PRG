#DEFINE NUL    0                                 && NUL
#DEFINE BOTOM  "  "+repl("°",78)                 && BOTOM
FUNCTION REMPEND
	RELE MIX_VARI,MIX_T1,MIX_R1,MIX_C1,MIX_COD,MIX_IND,MIX_R2,MIX_C2,MIX_ALIAS,MIX_CAMPO,MIX_LARGO
	PUBL MIX_VARI,MIX_T1,MIX_R1,MIX_C1,MIX_COD,MIX_IND,MIX_R2,MIX_C2,MIX_ALIAS,MIX_CAMPO,MIX_LARGO
	=OPKARS()
	SCAT MEMV BLANK
	=OPCOR()
	=OPREM()
 	=OPRPV()
	=OPPEN()
	=OPTALS()
	=OPMER()
	=OPAVIS()
	SET ORDER TO AVICODPRO
	DO WHILE .T.
		M.REMNRO=GETNU1("REMITOF","FOXGRL")+1
		M.REMITO='M0000-'+ZERO(M.REMNRO,8)
		STORE DATE() TO M.FECHAOP
		STORE ''     TO M.TALLER, M.DETALLE
		DO GENREMI.SPR
		IF LAST()=27
			EXIT
		ELSE
			SELE PEN
			COUNT FOR M.TALLER=TALLER TO CUANTOBL
			IF EMPTY(CUANTOBL)
				WAIT "No tiene Env¡os PENDIENTES" WIND NOWA
			ELSE
				SELE PEN
				SET ORDER TO TALLER
				PUSH KEY CLEAR
				ON KEY LABEL DEL DO DELEAVIP
				ON KEY LABEL INS DO REPLAVIP
				ON KEY LABEL TAB KEYBOARD "{Ctrl+W}"
				=MEN_LIN("[DEL] BORRA LINEA - [INS] POPUP DE AVIOS (STOCK) - [TAB] SALE")
				=MOVEWIN(2,0,13,78,"XXREMPEND"," Pendientes Taller: "+PER.CODCLI+"-"+ALLTR(PER.CLIENTE)+' ')
				SELE PEN
				REPL ALL ENVIADA WITH NUL
				GO TOP
				BROW FIELD;
					NUMERO:H="O.C.":P="999999":6,;
					AVICODPRO:H='ARTICULO':20,;
					ZA=SAYGRL(PEN.AVICODPRO,'AVIS','AVICODPRO','AVIS.AVIO'):H='DESCRIPCION':15, ;
					CANTIDAD :H='CANTIDAD':P="9999999.9999",;
					ENVIADA:H='ENVIADO':P='9999999.9999':V=ENVIADA<=CANTIDAD :E="enviado MAYOR que lo pedido", ;
					MEDIDA:H='UNIDAD':10 ;
					KEY M.TALLER IN WIND XXREMPEND NOMENU NOCLEA FREEZE ENVIADA
				POP KEY
				COUNT FOR !EMPTY(ENVIADA) TO CUANTOBL
				SET ORDER TO NUMERO
				IF LAST()#27 .AND. !EMPTY(CUANTOBL) .AND. CONFIRMA("El Remito", .T., 20, 60)
					STORE NUL TO M.NUMOT
					SELE PEN
					SCAN FOR !EMPTY(ENVIADA)
						M.AVICODPRO=AVICODPRO
						M.CANTIDAD=ENVIADA
						M.NUMERO=NUMERO
						IF EMPTY(M.NUMOT)
							M.NUMOT=M.NUMERO
						ENDIF
						IF M.NUMOT#M.NUMERO
							*** PASA A REMITOF.DBF
							=AGRABAR('REM')
							=PUTNU1("REMITOF",M.REMNRO,"FOXGRL")
							*** IMPRIME EL REMITO
							DO LREMIC WITH M.REMITO
							SELE PEN
							M.REMNRO=GETNU1("REMITOF","FOXGRL")+1
							M.REMITO='M0000-'+ZERO(M.REMNRO,8)
							M.NUMOT=M.NUMERO
						ENDIF
						IF CANTIDAD > ENVIADA
							**** PASA A PENDIENTES.DBF
							REPL CANTIDAD WITH CANTIDAD-ENVIADA
						ELSE
							**** BORRA DE PENDIENTES.DBF
							DELE
						ENDIF
						*** PASA A REMITDAF.DBF
						M.TIPO='A'
						=AGRABAR('REX')
						*** PASA A KARDEX.DBF
						STORE M.CANTIDAD TO M.SALIDA
						M.COMPR='RF'
						M.NUMERO=ZERO(M.REMNRO,8)
						M.REFERENCIA="O.C. N§ "+ZERO(NUMERO, 8)
						=AGRABAR("KARS")
						SELE KARS
						*** AJUSTA EL STOCK
						=AJSTOCK(0-M.CANTIDAD,201)
						=IAUD(M.AVICODPRO+"/"+ALLT(STR(M.CANTIDAD)))
						SELE PEN
					ENDSCAN
					M.REMNRO=GETNU1("REMITOF","FOXGRL")+1
					M.REMITO='M0000-'+ZERO(M.REMNRO,8)
					*** PASA A REMITOF.DBF
					=AGRABAR('REM')
					=PUTNU1("REMITOF",M.REMNRO,"FOXGRL")
					*** IMPRIME EL REMITO
					DO LREMIC WITH M.REMITO
				ENDIF
			ENDIF
		ENDIF
		=RELEWIN("XXREMPEND")
		=MEN_LIN(BOTOM)
	ENDDO
	=RELEWIN("GENREMI")
	USE IN REM
	USE IN REX
RETURN .T.

PROCEDURE REPLAVIP
	PUSH KEY CLEA
	IF !EMPTY(ELIAVIS("C¢digo del av¡o",-1,1))
		REPL PEN.AVICODPRO WITH AVIS.AVICODPRO
	ENDIF
	POP KEY
	=MEN_LIN(BOTOM)
RETURN

PROCEDURE DELEAVIP
IF !DELE()
	PUSH KEY CLEA
	IF XSEEK(PEN.AVICODPRO,"AVIS","AVICODPRO")
	   SELE AVIS
	   =LOCK() .OR. LOK()
	   REPL AVIS.STKRESPEN WITH AVIS.STKRESPEN-PEN.CANTIDAD
	   UNLO IN AVIS
	ENDIF
	SELE PEN
    =LOCK() .OR. LOK()	
	DELE
    UNLO IN PEN	
    =MEN_LIN(BOTOM)
	POP KEY   
ENDIF   
RETURN SGET("XXREMPEND")
