***********************************
** CHEQUEA CONSISTENCIA DEL KARDEX
***********************************
=WORKING()
=DOTALK()
=OPKAR()
STORE .T. TO HIZOALGO
DO WHILE HIZOALGO
   INDEX ON ;
     ARTICULO+STR(REMESA)+CLIENTE+STR(SALIDA) ;
     TO (GENTMP()) ;
     FOR PROVEEDOR .AND. OPK#'02' .AND. !EMPTY(OPK)
   STORE "" TO ELPRO,ELCLIENTE
   STORE NUL TO LACANT,SOBRA,LAREMESA,STOCK
   STORE .F. TO HIZOALGO
   SCAN
      IF KAR.CLIENTE#ELCLIENTE .OR. KAR.REMESA#LAREMESA
         LAREMESA=KAR.REMESA
         ELCLIENTE=KAR.CLIENTE
         STOCK=KAR.ENTRADA
         ELPRO=KAR.ARTICULO
         SOBRA=0
      ENDIF
      IF !EMPTY(KAR.SALIDA)
      IF STOCK-KAR.SALIDA>=0
         STOCK=STOCK-KAR.SALIDA
      ELSE
         SELE KAR
         QUEDA=STOCK
         SOBRA=KAR.SALIDA-STOCK
         SCAT MEMV
         REPL KAR.SALIDA WITH QUEDA
         SCAN WHILE KAR.CLIENTE=ELCLIENTE .AND. KAR.REMESA=LAREMESA
         ENDSCAN
         SCAN WHILE EMPTY(SALIDA)
         ENDSCAN
         IF ELPRO=KAR.ARTICULO
            M.CLIENTE=KAR.CLIENTE
            M.DETALLE=KAR.DETALLE
            M.REMESA=KAR.REMESA
            M.KILOS=KAR.KILOS
            M.SALIDA=SOBRA
            =AGRABAR("KAR")
            STORE .T. TO HIZOALGO
         ENDIF
         EXIT
      ENDIF
      ENDIF
   ENDSCAN
ENDDO
=REOPKAR()
=UNTALK()
=UNWORK()
RETURN
