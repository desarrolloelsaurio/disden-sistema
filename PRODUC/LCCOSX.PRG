#DEFINE PAIP   "|"                            && PAIP
#DEFINE BOTOM  "  "+repl("°",78)              && BOTOM
#DEFINE CRLF CHR(13)+CHR(10)                     && CRLF

PROCEDURE LCCOSX
PARAMETER YLAMADRE
STORE .T. TO CONCOLORES
=CLOSDBF("TMP")
=PRXAREA(.T.)
IF GETDBF('LCCOSX',.F.,"TMP",PRXAREA())
	SELE TMP
	TMP=DBF()
	USE
ELSE
	TMP="F:\SISTEMAS\PRODUC\PRODUCA\LCCOSX.DBF"
ENDIF
TMP2=GENTMP()
IF PREGUNTA("Empieza con un archivo NUEVO",.t.,10,30)="SI"
	CREATE TABLE (TMP) ;
  		(ARTICULO C(15), MERCA C(25), CURVA C(10), NROCURVAS N(7,2), NROUNIDAD N(7,2), COLOR C(2))
ENDIF
USE (TMP) ALIAS TMP
=MOVEWIN(5,1,18,78,"LCCOS"," Articulos a Listar ", " [INS] Agrega - [DEL] Borra - [ENTER] Modif. - [TAB] Sale ")
PUSH KEY CLEAR
ON KEY LABEL INS    DO EDITSX.SPR WITH "A"
ON KEY LABEL DEL    DO EDITSX.SPR WITH "B"
ON KEY LABEL ENTER  DO EDITSX.SPR WITH "M"
ON KEY LABEL TAB	KEYBOARD "{CTRL+W}"
BROW FIELDS ;
  ARTICULO:H='C¢DIGO ART.' ,;
  MERCA:H='DESCRIPCION' ,;
  CURVA:H='CURVA' ,;
  NROCURVAS:H='Nø CURVAS' ,;
  NROUNIDAD:H='Nø ARTICULOS' FREEZE ARTICULO NOED in lccos
POP KEY ALL
=RELEWIN('LCCOS')
GO TOP
IF !EMPTY(RECC("TMP")) .AND. LAST()#27
   =WORKING()
   =DOTALK()
   SELE CUR
   SET ORDE TO TAG CURVA
   SELE DES
   COPY STRU TO (TMP2)
   TMP3=GENTMP()
   COPY STRU TO (TMP3)
   =PRXAREA(.T.)
   USE (TMP3) ALIAS TMP3
   SELE TMP
   SCAN
      SELE DES
      IF USED("TMP2")
         USE IN TMP2
      ENDIF
      SORT ON ARTICULO,TALLE TO (TMP2) FOR ARTICULO=TMP.ARTICULO
      =PRXAREA(.T.)
      USE (TMP2) ALIAS TMP2
      SELE CUR
      SEEK TMP.CURVA
      DO WHILE CURVA=TMP.CURVA .AND. !EOF()
         SELE TMP2
         REPLACE CANTIDAD WITH CANTIDAD*CUR.CANTIDAD*TMP.NROCURVAS,;
           USUARIO WITH '' FOR CUR.TALLE=TALLE
         SELE CUR
         SKIP
      ENDD
      SELE TMP2
      DELE FOR !EMPTY(USUARIO)
      SELE TMP3
      APPEND FROM (TMP2)
      SELE TMP
   ENDSCAN
   TMP4=GENTMP()
   SELE TMP3
   SORT ON AVICODPRO, TELCODPRO TO (TMP4)
   =PRXAREA(.T.)
   USE (TMP4) ALIAS TMP4
   REPL ALL AVICODPRO WITH TELCODPRO FOR !EMPTY(TELCODPRO)
   TMP5=GENTMP()
   SELE TMP4
   TOTAL ON AVICODPRO TO (TMP5) FIELD CANTIDAD
   =PRXAREA(.T.)
    USE (TMP5) ALIAS TMP5 EXCL
	IF YLAMADRE
		SELE TMP5
		REPL ALL USUARIO WITH ""
		SET ORDER TO TAG TELCODPRO IN TELS
		SET RELA TO TELCODPRO INTO TELS
		REPL USUARIO WITH TELS.MADRE FOR !EMPTY(TELCODPRO)
		SET ORDER TO TAG AVICODPRO IN AVIS
		SET RELA TO AVICODPRO INTO AVIS
		REPL USUARIO WITH AVIS.MADRE FOR EMPTY(TELCODPRO)
		SET RELA OFF INTO AVIS
		TMP6=GENTMP()
		TMP7=GENTMP()
		COPY TO (TMP6) FOR EMPTY(USUARIO)
		DELE FOR EMPTY(USUARIO)
		PACK
		INDEX ON USUARIO TAG USUARIO
		SET ORDER TO TAG USUARIO
		TOTAL ON USUARIO TO (TMP7) FIELD CANTIDAD
		=PRXAREA(.T.)
		USE (TMP7) EXCL ALIAS TMP7
		REPL ALL TELCODPRO WITH " -> "+USUARIO+" <-"
		APPE FROM (TMP6)
		**** GENERA UN NUEVO ARCHIVO CON LOS HIJOS DE TELAS AGRUPADOS
		TMP10=GENTMP()
		TMP11=GENTMP()
		SELE TELS
		=FLOCK() .OR. FLOK()
		SORT ON MADRE TO (TMP10) FOR !EMPTY(MADRE)
		=UNLO_PRX("TELS",TMP10,"TMP10")
		SELE TMP10
		TOTAL ON MADRE TO (TMP11) FIELD ;
        STOCK,STOCKRES,STKRESPEN,STKENTPEN
		=PRXAREA(.T.)
		USE (TMP11) ALIAS TELTEMP
		REPL ALL TELCODPRO WITH MADRE
		SET ORDER TO TAG CODMADRE IN TMA
		SET RELA TO MADRE INTO TMA
		REPL TELA WITH TMA.TELMADRE FOR !EMPTY(TMA.TELMADRE)
		SET RELA OFF INTO TMA
		APPE FROM DBF("TELS") FOR EMPTY(MADRE)
		INDEX ON TELCODPRO TAG TELCODPRO		
	ENDIF
   =UNTALK()
   =UNWORK()
   STORE "99999999.99" TO ELPI1
   TT="COSTOS DE PRODUCCION: PROYECCION"+;
   CRLF+;
   IIF(YLAMADRE,"Despiece Agrupado","Despiece Nominal")
   ACLA=PAIP+PADC("ARTICULO",15)+PAIP+PADC("DESCRIPCION",25)+;
     PAIP+PADC("CURVA",10)+PAIP+PADC("CANT.CURVAS",7)+PAIP+PADC("CANT.ARTICULOS",7)+PAIP
   =XPRN1(4,"TMP","LCCOSX0()","PROY.","LCCOSX",1,ELPI1)
   ACLA=PAIP+PADC("ARTICULO",20)+PAIP+PADC("DESCRIPCION",20)+;
     PAIP+PADC("PROVEEDOR",15)+PAIP+PADC("CANTIDAD",11)+PAIP+"UNID."+;
     PAIP+PADC("STK.REAL",11)+PAIP+PADC("STK.RESERVADO",11)+;
     PAIP+PADC("COMPRADO",11)+;
     PAIP+PADC("NECESIDAD",11)+PAIP+PADC("COSTO",11)+PAIP
   =XPRN1(4,IIF(YLAMADRE,"TMP7","TMP5"),"LCCOSX1()","PROY.","LCCOSX",1,ELPI1)
ENDIF
=CLOSDBF("TMP")
=OFF_TMP()
RETURN MEN_LIN(BOTOM)
