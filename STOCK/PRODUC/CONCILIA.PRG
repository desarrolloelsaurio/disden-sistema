#DEFINE PAIP   "|"                               && PAIP
#DEFINE CRLF CHR(13)+CHR(10)                     && CRLF
* MODIFICACION 02/10/95 11:03 - AGREGO OPCION POR TEMPORADA Y CONTROL FECHA
PROCEDURE CONCILIA
	PARA PORPAN,POR_FECHA,RES_UMIDO
	=OPAVIS()
	=OPREQ()
	=OPPRO()
	=OPCOMS()
	IF POR_FECHA
		M.TEMPORADA=SPACE(10)
		DO ELITEM.SPR
		M.LATEMPO=M.TEMPORADA
	ENDIF
	DO WHILE ELIPRO()
		=WORKING()
		=DOTALK()
		=FLOCK("REQX") .OR. FLOK("REQX")
		=FLOCK("REQ") .OR. FLOK("REQ")
		TMP=GENTMP()
		TMPFEC=GENTMP()
		SET ORDER TO TAG COMCODPRO IN COMS
		SELE REQX
		SET ORDER to TAG NUMERO IN REQ
		SET RELA TO NUMERO INTO REQ
		SET RELA TO COMCODPRO INTO COMS ADDI
		IF POR_FECHA
			SORT TO (TMP) ON COMS.COMPRA FOR ;
				REQ.PROCOD=PER.CODCLI .AND. !EMPTY(COMCODPRO) .AND. ;
				REQ.TEMPORADA=M.LATEMPO FIELDS ;
				COMCODPRO, PEDIDO, RECIBIDO, COMS.COMPRA, AVIS.AVIO, ;
				AVIS.STOCKRES, AVIS.STOCKMAX, AVIS.STOCKMIN, REQ.FECHAOP, ;
				AVIS.STOCK, AVIS.STOCKUSO
		ELSE
			SORT TO (TMP) ON COMS.COMPRA FOR ;
				REQ.PROCOD=PER.CODCLI .AND. !EMPTY(COMCODPRO) FIELDS ;
				COMCODPRO, PEDIDO, RECIBIDO, COMS.COMPRA, AVIS.AVIO, ;
				AVIS.STOCKRES, AVIS.STOCKMAX, AVIS.STOCKMIN, REQ.FECHAOP, ;
				AVIS.STOCK, AVIS.STOCKUSO
		ENDIF
		UNLO ALL
		=OFF_RELA()
		=PRXAREA(.T.)
		USE (TMP) ALIAS TMP
		IF POR_FECHA                               && PONE LA FECHA MENOR PARA EL FILTRO
			INDEX ON COMCODPRO+DTOS(FECHAOP) TAG PORFECHA
			SET ORDER TO TAG PORFECHA
			GO TOP
			M.ELART=COMCODPRO
			M.LAFECHA=FECHAOP
			SCAN
				IF ELART#COMCODPRO
					M.ELART=COMCODPRO
					M.LAFECHA=FECHAOP
				ENDIF
				REPL COMCODPRO WITH M.ELART
				REPL FECHAOP WITH M.LAFECHA
			ENDSCAN
			SET ORDER TO
		ENDIF
		TMP3=GENTMP()
		TOTAL ON COMCODPRO FIELDS PEDIDO, RECIBIDO TO (TMP3)
		=PRXAREA(.T.)
		USE (TMP3) ALIAS TMP3
		REPL ALL COMCODPRO WITH AJCODMER(ALLTRIM(COMCODPRO)+"/00"),;
			AVIO WITH " "+PAIP, STOCKRES WITH 0,;
			STOCKMAX WITH 0, STOCKMIN WITH 0, ;
			STOCK WITH 0, STOCKUSO WITH 0
		INDE ON LEFT(COMCODPRO,10) TAG ARTICULO
		SET ORDER TO TAG ARTICULO
		=OPCOR()
		SELE COR
		SET RELA TO ARTICULO INTO TMP3
		IF POR_FECHA
			REPLACE FOR !EOF("TMP3") .AND. COR.FECHAINI>=TMP3.FECHAOP ;
				TMP3.STOCKRES WITH TMP3.STOCKRES+COR.CANTINI ,;
				TMP3.STOCKMAX WITH TMP3.STOCKMAX+COR.TERM1+COR.TERM1L ,;
				TMP3.STOCKMIN WITH TMP3.STOCKMIN+COR.TERM2+COR.TERM2E ,;
				TMP3.STOCK WITH TMP3.STOCK+COR.REPROCESO+COR.REINTEGRO+COR.PERDIDO,;
				TMP3.STOCKUSO WITH TMP3.STOCKUSO+COR.CANTINI ,;
				TMP3.AVIO WITH ALLTRIM(TMP3.AVIO)+ALLTRIM(STR(COR.NUMERO))+PAIP
		ELSE
			REPLACE FOR !EOF("TMP3") ;
				TMP3.STOCKRES WITH TMP3.STOCKRES+COR.CANTINI ,;
				TMP3.STOCKMAX WITH TMP3.STOCKMAX+COR.TERM1+COR.TERM1L ,;
				TMP3.STOCKMIN WITH TMP3.STOCKMIN+COR.TERM2+COR.TERM2E ,;
				TMP3.STOCK WITH TMP3.STOCK+COR.REPROCESO+COR.REINTEGRO+COR.PERDIDO,;
				TMP3.STOCKUSO WITH TMP3.STOCKUSO+COR.CANTINI ,;
				TMP3.AVIO WITH ALLTRIM(TMP3.AVIO)+ALLTRIM(STR(COR.NUMERO))+PAIP
		ENDIF
		USE IN COR
		=UNWORK()
		=UNTALK()
		TT='Conciliaci¢n entre Ordenes de Requerimiento y Ordenes de Corte'+;
			CRLF+;
			ALLTRIM(PER.CLIENTE)
		FISC=ALLT(PER.CODCLI)+'-'+ALLT(PER.CLIENTE)
		IF POR_FECHA
			TT=TT+;
				CRLF+;
				"Temporada : "+M.LATEMPO
			FISC=FISC+'-'+ALLT(PER.CLIENTE)
		ENDIF
	IF RES_UMIDO
		TT=TT+;
			CRLF+;
			"RESUMIDO (DDHLBPF)"
		ACLA=PAIP+;
			PADC("CODIGO",10)+PAIP+;
			PADC("ARTICULO",30)+PAIP+;
			PADC("REQ PEND",XACDIGI)+PAIP+;
			PADC("PROD PEND",XACDIGI)+PAIP+;
			PADC("DIFERENCIA",XACDIGI)+PAIP
	ELSE
		ACLA=PAIP+;
			PADC("CODIGO",10)+PAIP+;
			IIF(PORPAN,"",PADC("ARTICULO",30)+PAIP)+;
			PADC("C.PEDIDA",XACDIGI)+PAIP+;
			PADC("C.RECIBIDA",XACDIGI)+PAIP+;
			PADC("C.PENDIENTE",XACDIGI)+PAIP+;
			PADC("ORDENES DE CORTE",30)+PAIP+;
			PADC("C.CORTE",XACDIGI)+PAIP+;
			PADC("1§",XACDIGI)+PAIP+;
			PADC("2§",XACDIGI)+PAIP+;
			PADC("OTROS",XACDIGI)+PAIP+;
			PADC("TOTAL",XACDIGI)+PAIP+;
			PADC("PENDIENTE",XACDIGI)+PAIP
		ENDIF
		=LGRL2(PORPAN, "TMP3","LPORART0(.T.)", FISC, "LORXOC"+IIF(POR_FECHA,"F","C")+IIF(RES_UMIDO,"R","C"))
		=OPREQ(.T.)
		=OFF_TMP()
	ENDDO
RETURN .T.
